
#define _GNU_SOURCE
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>

#include "argv-fuzz-inl.h"

/**
 * Converts arguments formatted for AFL's argv parser,
 * to regular arguments as if a command was invoked from the shell.
 * For example:
 * echo -en 'echo\x00baz\x00\x00' | ./afl-argv-converter
 * will run:
 * echo baz
 */
int main(int argc, char* argv[], char *envp[]) {
    int res;

    AFL_INIT_ARGV();
    extern const char *__progname;
	__progname = argv[0];

    printf("Executing %s with argc=%d:\n", argv[0], argc);
	for(int i=0; i<argc; i++) {
		printf(" [*] argv[%d]=%s\n", i, argv[i]);
	}
    printf("Issuing execvpe now.\n");
    res = execvpe(argv[0], argv, envp);

    //we get here only if execvpe fails
    perror("execvpe");
    return res;
}
