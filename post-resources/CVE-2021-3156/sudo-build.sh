#!/bin/bash

set -e

# Script should be in the same directory as the sudo source code.
# Run as root.

# We need to run `make install` otherwise the binary does not work properly.
# e.g. it assumes it is in /usr/bin/sudo or that sudoers file exsits, etc.
# That's why also ./configure --prefix=XXX does not work properly

make_original() {
    # FIXME: Since --disabled-shared is not there,
    # we have not dealt with libraries under /usr/local/libexec/sudo/*
    ./configure
    make clean && make
    make install
    cp /usr/local/bin/sudo /usr/local/bin/sudo-original
    chmod +s /usr/local/bin/sudo-original
}

make_original_debug() {
    # FIXME: Since --disabled-shared is not there,
    # we have not dealt with libraries under /usr/local/libexec/sudo/*
    CFLAGS="-g"
    CFLAGS="$CFLAGS" CXXFLAGS="$CFLAGS" LDFLAGS="-g" CPPFLAGS="-DCRASH_EXPLORATION" ./configure
    make clean && make
    make install
    cp /usr/local/bin/sudo /usr/local/bin/sudo-original-debug
    chmod +s /usr/local/bin/sudo-original-debug
}

make_afl() {
    # export AFL_USE_ASAN=1
    CC=afl-clang-fast CXX=afl-clang-fast++ \
        CPPFLAGS="-DAFL_ARGV -DCRASH_EXPLORATION" \
        ./configure --disable-shared
    make clean && make
    make install
    cp /usr/local/bin/sudo /usr/local/bin/sudo-afl
    chmod +s /usr/local/bin/sudo-afl
}

make_asan() {
    # Same clang version as afl-clang-fast
    CFLAGS="-fsanitize=address -fno-omit-frame-pointer -ggdb -O0"
    LDFLAGS="-fsanitize=address"
    CC=clang-14 CXX=clang++-14 \
        CPPFLAGS="-DAFL_ARGV" \
        CFLAGS="$CFLAGS" \
        CXXFLAGS="$CFLAGS" \
        LDFLAGS="$LDFLAGS" \
        ./configure --disable-shared
    make clean && make
    make install
    cp /usr/local/bin/sudo /usr/local/bin/sudo-asan
    chmod +s /usr/local/bin/sudo-asan
}

make_taintgrind() {
    # Same clang version as afl-clang-fast
    CFLAGS="-fno-inline -fno-omit-frame-pointer -ggdb -O0"
    CPPFLAGS="-I/root/valgrind-3.21.0/include -I/root/valgrind-3.21.0/taintgrind -DTAINTGRIND" \
        CFLAGS="$CFLAGS" \
        CXXFLAGS="$CFLAGS" \
        ./configure --disable-shared
    make clean && make
    make install
    cp /usr/local/bin/sudo /usr/local/bin/sudo-taintgrind
    # valgrind cannot deal with setuid binaries
    # chmod +s /usr/local/bin/sudo-taintgrind
    # Example run command:
    # /root/valgrind-3.21.0/build/bin/taintgrind /home/user/mount/sudoedit/02-exploit/taintgrind-0edit -hB -i AA\\ BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB
}

make_original
make_original_debug
make_afl
make_asan
# make_taintgrind

rm -f /usr/local/bin/sudo /usr/local/bin/sudoedit
